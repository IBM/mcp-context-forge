# ===============================================================
# üì¶ Secure Docker Build & Scan Workflow
# ===============================================================
#
# This workflow:
#   ‚Ä¢ Builds and tags the container image (`latest` + timestamp)
#   ‚Ä¢ Re-uses a BuildKit layer cache for faster rebuilds
#   ‚Ä¢ Lints the Dockerfile with Hadolint (CLI) ‚Üí SARIF
#   ‚Ä¢ Lints the finished image with Dockle (CLI) ‚Üí SARIF
#   ‚Ä¢ Generates an SPDX SBOM with Syft
#   ‚Ä¢ Scans the image for CRITICAL/HIGH CVEs with Trivy
#   ‚Ä¢ Uploads Hadolint, Dockle and Trivy results as SARIF files
#   ‚Ä¢ Pushes the image to GitHub Container Registry (GHCR)
#   ‚Ä¢ Signs & attests the image with Cosign **key-less (OIDC)**
#
# Triggers:
#   ‚Ä¢ Every push / PR to `main`
#   ‚Ä¢ Weekly scheduled run (Tue 18:17 UTC) to catch new CVEs
# ---------------------------------------------------------------

name: Secure Docker Build

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '17 18 * * 2'        # Tuesday @ 18:17 UTC

# -----------------------------------------------------------------
# GitHub permission scopes for this job
# -----------------------------------------------------------------
permissions:
  contents: read
  packages: write          # push to ghcr.io with built-in GITHUB_TOKEN
  security-events: write   # upload SARIF to ‚ÄúCode-scanning alerts‚Äù
  actions: read            # needed by upload-sarif in private repos

jobs:
  build-scan-sign:
    runs-on: ubuntu-latest

    env:
      IMAGE_NAME: ghcr.io/${{ github.repository }}
      CACHE_DIR: /tmp/.buildx-cache          # BuildKit layer cache dir

    steps:
    # -------------------------------------------------------------
    # 0Ô∏è‚É£  Checkout source
    # -------------------------------------------------------------
    - name: ‚¨áÔ∏è  Checkout code
      uses: actions/checkout@v4

    # -------------------------------------------------------------
    # 1Ô∏è‚É£  Dockerfile lint (Hadolint CLI ‚Üí SARIF)
    # -------------------------------------------------------------
    - name: üîç Dockerfile lint (Hadolint)
      id: hadolint
      continue-on-error: true                # still upload SARIF on failure
      run: |
        curl -sSL https://github.com/hadolint/hadolint/releases/latest/download/hadolint-Linux-x86_64 -o /usr/local/bin/hadolint
        chmod +x /usr/local/bin/hadolint
        hadolint -f sarif Containerfile.lite > hadolint-results.sarif
        echo "HADOLINT_EXIT=$?" >> "$GITHUB_ENV"
        exit 0                               # ensure step reports success

    - name: ‚òÅÔ∏è  Upload Hadolint SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: hadolint-results.sarif

    # -------------------------------------------------------------
    # 2Ô∏è‚É£  Set up Buildx & restore cache
    # -------------------------------------------------------------
    - name: üõ†Ô∏è  Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: üîÑ  Restore BuildKit layer cache
      uses: actions/cache@v4
      with:
        path: ${{ env.CACHE_DIR }}
        key:  ${{ runner.os }}-buildx-${{ github.sha }}
        restore-keys: ${{ runner.os }}-buildx-

    # -------------------------------------------------------------
    # 3Ô∏è‚É£  Build & tag image (timestamp + latest)
    # -------------------------------------------------------------
    - name: üèóÔ∏è  Build Docker image
      run: |
        TAG=$(date +%s)
        echo "TAG=$TAG" >> "$GITHUB_ENV"     # reuse in push step
        docker buildx build \
          --file Containerfile.lite \
          --tag $IMAGE_NAME:$TAG \
          --tag $IMAGE_NAME:latest \
          --cache-from type=local,src=${{ env.CACHE_DIR }} \
          --cache-to   type=local,dest=${{ env.CACHE_DIR }},mode=max \
          --load \
          .                                  # build context is mandatory

    # -------------------------------------------------------------
    # 4Ô∏è‚É£  Image lint (Dockle CLI ‚Üí SARIF)
    # -------------------------------------------------------------
    - name: üîç Image lint (Dockle)
      id: dockle
      continue-on-error: true
      env:
        DOCKLE_VERSION: 0.4.15
      run: |
        curl -sSL "https://github.com/goodwithtech/dockle/releases/download/v${DOCKLE_VERSION}/dockle_${DOCKLE_VERSION}_Linux-64bit.tar.gz" \
          | tar -xz -C /usr/local/bin dockle
        dockle --exit-code 1 \
               --format sarif \
               --output dockle-results.sarif \
               $IMAGE_NAME:latest
        echo "DOCKLE_EXIT=$?" >> "$GITHUB_ENV"
        exit 0

    - name: ‚òÅÔ∏è  Upload Dockle SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: dockle-results.sarif

    # -------------------------------------------------------------
    # 5Ô∏è‚É£  Generate SPDX SBOM with Syft
    # -------------------------------------------------------------
    - name: üìÑ Generate SBOM (Syft)
      uses: anchore/sbom-action@v0
      with:
        image: ${{ env.IMAGE_NAME }}:latest
        output-file: sbom.spdx.json

    # -------------------------------------------------------------
    # 6Ô∏è‚É£  Trivy CVE scan ‚Üí SARIF  (fails on CRITICAL/HIGH)
    # -------------------------------------------------------------
    - name: üõ°Ô∏è  Trivy vulnerability scan
      id: trivy
      continue-on-error: true                # allow SARIF upload
      uses: aquasecurity/trivy-action@7b7aa264d83dc58691451798b4d117d53d21edfe
      with:
        image-ref: ${{ env.IMAGE_NAME }}:latest
        format: sarif
        output: trivy-results.sarif
        severity: CRITICAL,HIGH
        exit-code: 1                         # non-zero on vulns

    - name: ‚òÅÔ∏è  Upload Trivy SARIF
      if: always()
      uses: github/codeql-action/upload-sarif@v3
      with:
        sarif_file: trivy-results.sarif

    # -------------------------------------------------------------
    # 7Ô∏è‚É£  Push both tags to GHCR (built-in GITHUB_TOKEN)
    # -------------------------------------------------------------
    - name: üîë Log in to GHCR
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: üöÄ Push image to GHCR
      run: |
        docker push $IMAGE_NAME:${{ env.TAG }}
        docker push $IMAGE_NAME:latest

    # -------------------------------------------------------------
    # 8Ô∏è‚É£  Key-less Cosign sign (OIDC) + provenance
    # -------------------------------------------------------------
    - name: üì• Install Cosign
      uses: sigstore/cosign-installer@v3

    - name: üîè Sign & attest image
      env:
        COSIGN_EXPERIMENTAL: "1"             # enable OIDC flow
      run: |
        cosign sign   --yes $IMAGE_NAME:latest
        cosign attest --yes --predicate sbom.spdx.json $IMAGE_NAME:latest

    # -------------------------------------------------------------
    # 9Ô∏è‚É£  Single gate ‚Äì fail job on any scanner error
    # -------------------------------------------------------------
    - name: ‚õî Enforce lint & vuln gates
      if: |
        env.HADOLINT_EXIT != '0' ||
        env.DOCKLE_EXIT   != '0' ||
        steps.trivy.outcome == 'failure'
      run: |
        echo "Hadolint exit: $HADOLINT_EXIT"
        echo "Dockle  exit: $DOCKLE_EXIT"
        echo "Trivy   status: ${{ steps.trivy.outcome }}"
        exit 1
