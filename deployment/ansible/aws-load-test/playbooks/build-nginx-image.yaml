---
- name: Build and push nginx-cache image to ECR
  hosts: "_bastion"
  become: false
  vars:
    github_repo: "https://github.com/ibm/mcp-context-forge.git"
    github_branch: "{{ github_branch_v | default('main') }}"
    image_name: "mcp-context-forge-nginx"
    build_context: "infra/nginx"
  environment:
    AWS_ACCESS_KEY_ID: "{{ access_key_v }}"
    AWS_SECRET_ACCESS_KEY: "{{ secret_key_v }}"
    AWS_REGION: "{{ region_v }}"
  tasks:
    # =========================================================================
    # Determine Target Architecture
    # =========================================================================

    - name: Get ECS instance type info
      ec2_describe_instance_types:
        filters:
          - name: instance-type
            values:
              - "{{ ecs_instance_type_v | default('c6i.12xlarge') }}"
      register: instance_type_r

    - name: Set target platform based on instance architecture
      ansible.builtin.set_fact:
        target_platform: "linux/{{ 'amd64' if instance_type_r.instance_types[0].processor_info.supported_architectures[0] == 'x86_64' else 'arm64' }}"

    # =========================================================================
    # Get Git commit hash for tagging
    # =========================================================================

    - name: Get latest commit hash from GitHub
      ansible.builtin.command: git ls-remote {{ github_repo }} {{ github_branch }}
      register: git_ls_remote_r
      changed_when: false

    - name: Set image tag from commit
      ansible.builtin.set_fact:
        image_tag: "{{ git_ls_remote_r.stdout.split()[0][:7] }}"

    # =========================================================================
    # ECR Setup
    # =========================================================================

    - name: Get AWS account ID
      ansible.builtin.command: aws sts get-caller-identity --query Account --output text
      register: aws_account_r
      changed_when: false

    - name: Set ECR registry URL
      ansible.builtin.set_fact:
        ecr_registry: "{{ aws_account_r.stdout }}.dkr.ecr.{{ region_v }}.amazonaws.com"
        ecr_repository: "{{ prefix_v }}/{{ image_name }}"

    - name: Create ECR repository if it doesn't exist
      ansible.builtin.command: >
        aws ecr create-repository
          --repository-name {{ ecr_repository }}
          --region {{ region_v }}
      register: ecr_create_r
      failed_when: ecr_create_r.rc != 0 and 'RepositoryAlreadyExistsException' not in ecr_create_r.stderr
      changed_when: ecr_create_r.rc == 0

    # =========================================================================
    # Docker Build and Push
    # =========================================================================

    - name: Login to ECR
      ansible.builtin.shell: |
        aws ecr get-login-password --region {{ region_v }} | \
        docker login --username AWS --password-stdin {{ ecr_registry }}
      changed_when: true

    - name: Build and push image with buildx from GitHub
      ansible.builtin.command: >
        docker buildx build
          --platform {{ target_platform }}
          --tag {{ ecr_registry }}/{{ ecr_repository }}:{{ image_tag }}
          --tag {{ ecr_registry }}/{{ ecr_repository }}:latest
          --push
          {{ github_repo }}#{{ github_branch }}:{{ build_context }}
      register: docker_build_r

    - name: Display build results
      ansible.builtin.debug:
        msg: |
          Image built and pushed successfully:
            Repository: {{ ecr_registry }}/{{ ecr_repository }}
            Tag: {{ image_tag }}
            Platform: {{ target_platform }}
            Latest: {{ ecr_registry }}/{{ ecr_repository }}:latest
