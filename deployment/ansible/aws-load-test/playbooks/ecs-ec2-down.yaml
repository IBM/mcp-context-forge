---
- name: Delete ECS Auto Scaling Group and capacity provider
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    ansible_python_interpreter: ../.venv/bin/python
    capacity_provider_name: "{{ prefix_v }}-ecs-capacity-provider"
  tasks:
    # =========================================================================
    # Remove Capacity Provider from Cluster
    # =========================================================================

    - name: Remove capacity provider association from cluster
      ansible.builtin.command: >
        aws ecs put-cluster-capacity-providers
          --cluster {{ prefix_v }}-ecs-cluster
          --capacity-providers []
          --default-capacity-provider-strategy []
          --region {{ region_v }}
      failed_when: false
      changed_when: true

    - name: Wait for capacity provider disassociation
      ansible.builtin.pause:
        seconds: 10

    # =========================================================================
    # Delete Capacity Provider
    # =========================================================================

    - name: Delete ECS Capacity Provider
      ecs_capacity_provider:
        state: absent
        name: "{{ capacity_provider_name }}"
      failed_when: false

    # =========================================================================
    # Delete Auto Scaling Group (terminates instances)
    # =========================================================================

    - name: Delete Auto Scaling Group
      amazon.aws.autoscaling_group:
        name: "{{ prefix_v }}-ecs-asg"
        region: "{{ region_v }}"
        state: absent
        wait_for_instances: true
        wait_timeout: 600
      retries: 5
      delay: 30

    # =========================================================================
    # Delete Launch Template
    # =========================================================================

    - name: Delete Launch Template
      amazon.aws.ec2_launch_template:
        name: "{{ prefix_v }}-ecs-launch-template"
        region: "{{ region_v }}"
        state: absent

    # =========================================================================
    # Clean up IAM Resources
    # =========================================================================

    - name: Delete ECS instance profile
      amazon.aws.iam_instance_profile:
        name: "{{ prefix_v }}-ecs-instance-profile"
        state: absent
      retries: 10
      delay: 15

    - name: Detach managed policies from ECS instance role
      amazon.aws.iam_role:
        name: "{{ prefix_v }}-ecs-instance-role"
        state: present
        managed_policies: []
        purge_policies: true
      failed_when: false
      retries: 5
      delay: 10

    - name: Delete ECS instance IAM role
      amazon.aws.iam_role:
        name: "{{ prefix_v }}-ecs-instance-role"
        state: absent
      retries: 10
      delay: 15
