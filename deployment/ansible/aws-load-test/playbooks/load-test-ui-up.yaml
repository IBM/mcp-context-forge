---
- name: Create ALB and expose Locust load testing UI
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    ansible_python_interpreter: ../.venv/bin/python
  tasks:
    # =========================================================================
    # Get Required Information
    # =========================================================================

    - name: Get VPC info
      amazon.aws.ec2_vpc_net_info:
        region: "{{ region_v }}"
        filters:
          "tag:Name": "{{ prefix_v }}-vpc"
      register: vpc_info_r

    - name: Set VPC ID fact
      ansible.builtin.set_fact:
        vpc_id_f: "{{ vpc_info_r.vpcs[0].id }}"

    - name: Get VPC public subnets
      amazon.aws.ec2_vpc_subnet_info:
        region: "{{ region_v }}"
        filters:
          "tag:Project": "{{ prefix_v }}"
          "map-public-ip-on-launch": true
      register: vpc_public_subnets_r

    - name: Find my public IPv4 address
      ansible.builtin.uri:
        url: https://ipv4.icanhazip.com
        return_content: true
        timeout: 5
      register: ipv4_response
      ignore_errors: true

    - name: Find my public IPv6 address
      ansible.builtin.uri:
        url: https://ipv6.icanhazip.com
        return_content: true
        timeout: 5
      register: ipv6_response
      ignore_errors: true

    - name: Set IP facts
      ansible.builtin.set_fact:
        my_ipv4: "{{ ipv4_response.content | default('') | trim }}"
        my_ipv6: "{{ ipv6_response.content | default('') | trim }}"
        has_ipv4: "{{ ipv4_response is success and ipv4_response.content | default('') | trim | length > 0 }}"
        has_ipv6: "{{ ipv6_response is success and ipv6_response.content | default('') | trim | length > 0 }}"

    - name: Get ALB security group
      amazon.aws.ec2_security_group_info:
        region: "{{ region_v }}"
        filters:
          group-name: "{{ prefix_v }}-alb-sg"
      register: alb_sg_info_r

    - name: Get bastion security group
      amazon.aws.ec2_security_group_info:
        region: "{{ region_v }}"
        filters:
          group-name: "{{ prefix_v }}-bastion-sg"
      register: bastion_sg_info_r

    - name: Get bastion instance
      amazon.aws.ec2_instance_info:
        region: "{{ region_v }}"
        filters:
          "tag:Name": "{{ prefix_v }}-bastion"
          "instance-state-name": running
      register: bastion_instance_r

    - name: Fail if bastion not found
      ansible.builtin.fail:
        msg: "Bastion instance not found or not running"
      when: bastion_instance_r.instances | length == 0

    # =========================================================================
    # Update Security Groups (dual-stack IPv4 + IPv6)
    # =========================================================================

    - name: Build ALB security group rules
      ansible.builtin.set_fact:
        alb_rules: >-
          {{
            (has_ipv4 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_ip': my_ipv4 + '/32'},
               {'proto': 'tcp', 'from_port': 443, 'to_port': 443, 'cidr_ip': my_ipv4 + '/32'}],
              []
            ) +
            (has_ipv6 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_ipv6': my_ipv6 + '/128'},
               {'proto': 'tcp', 'from_port': 443, 'to_port': 443, 'cidr_ipv6': my_ipv6 + '/128'}],
              []
            )
          }}

    - name: Build bastion security group rules
      ansible.builtin.set_fact:
        bastion_rules: >-
          {{
            (has_ipv4 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_ip': my_ipv4 + '/32'},
               {'proto': 'tcp', 'from_port': 8089, 'to_port': 8089, 'cidr_ip': my_ipv4 + '/32'}],
              []
            ) +
            (has_ipv6 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_ipv6': my_ipv6 + '/128'},
               {'proto': 'tcp', 'from_port': 8089, 'to_port': 8089, 'cidr_ipv6': my_ipv6 + '/128'}],
              []
            ) +
            [{'proto': 'tcp', 'from_port': 8089, 'to_port': 8089, 'group_id': alb_sg_info_r.security_groups[0].group_id}]
          }}

    - name: Update ALB security group for HTTPS
      amazon.aws.ec2_security_group:
        name: "{{ prefix_v }}-alb-sg"
        description: Allow HTTP/HTTPS from my IP (IPv4 and IPv6)
        region: "{{ region_v }}"
        vpc_id: "{{ vpc_id_f }}"
        tags:
          "Name": "{{ prefix_v }}-alb-sg"
        rules: "{{ alb_rules }}"

    - name: Add ALB access to bastion security group for Locust
      amazon.aws.ec2_security_group:
        name: "{{ prefix_v }}-bastion-sg"
        description: Allow SSH and Locust access (IPv4 and IPv6)
        region: "{{ region_v }}"
        vpc_id: "{{ vpc_id_f }}"
        tags:
          "Name": "{{ prefix_v }}-bastion-sg"
        rules: "{{ bastion_rules }}"

    # =========================================================================
    # Create Target Group for Locust and Look Up ECS Target Groups
    # =========================================================================

    - name: Create target group for Locust UI (default route)
      community.aws.elb_target_group:
        name: "{{ prefix_v }}-locust-tg"
        protocol: HTTP
        port: 8089
        vpc_id: "{{ vpc_id_f }}"
        region: "{{ region_v }}"
        health_check_path: /
        health_check_protocol: HTTP
        health_check_interval: 30
        health_check_timeout: 5
        healthy_threshold_count: 2
        unhealthy_threshold_count: 2
        target_type: instance
        state: present
        targets:
          - Id: "{{ bastion_instance_r.instances[0].instance_id }}"
            Port: 8089
      register: locust_target_group_r

    - name: Define ECS target groups to wait for
      ansible.builtin.set_fact:
        ecs_target_groups:
          - name: "{{ prefix_v }}-nginx-tg"
            var_name: nginx_tg_arn
          - name: "{{ prefix_v }}-gateway-tg"
            var_name: gateway_tg_arn
          - name: "{{ prefix_v }}-pgadmin-tg"
            var_name: pgadmin_tg_arn
          - name: "{{ prefix_v }}-redis-cmd-tg"
            var_name: redis_commander_tg_arn

    - name: Wait for ECS target groups to be ready
      community.aws.elb_target_group_info:
        names:
          - "{{ item.name }}"
        region: "{{ region_v }}"
      register: tg_wait_result
      retries: 30
      delay: 10
      until: tg_wait_result.target_groups | length > 0
      loop: "{{ ecs_target_groups }}"
      loop_control:
        label: "{{ item.name }}"

    - name: Get all ECS target group ARNs
      community.aws.elb_target_group_info:
        names: "{{ ecs_target_groups | map(attribute='name') | list }}"
        region: "{{ region_v }}"
      register: all_tg_info_r

    - name: Set target group ARN facts
      ansible.builtin.set_fact:
        nginx_tg_arn: "{{ all_tg_info_r.target_groups | selectattr('target_group_name', 'equalto', prefix_v + '-nginx-tg') | map(attribute='target_group_arn') | first }}"
        gateway_tg_arn: "{{ all_tg_info_r.target_groups | selectattr('target_group_name', 'equalto', prefix_v + '-gateway-tg') | map(attribute='target_group_arn') | first }}"
        pgadmin_tg_arn: "{{ all_tg_info_r.target_groups | selectattr('target_group_name', 'equalto', prefix_v + '-pgadmin-tg') | map(attribute='target_group_arn') | first }}"
        redis_commander_tg_arn: "{{ all_tg_info_r.target_groups | selectattr('target_group_name', 'equalto', prefix_v + '-redis-cmd-tg') | map(attribute='target_group_arn') | first }}"

    # =========================================================================
    # Create ALB with Path-Based Routing
    # =========================================================================

    - name: Create Application Load Balancer with path-based routing
      amazon.aws.elb_application_lb:
        name: "{{ prefix_v }}-alb"
        region: "{{ region_v }}"
        security_groups:
          - "{{ alb_sg_info_r.security_groups[0].group_id }}"
        subnets: "{{ vpc_public_subnets_r.subnets | map(attribute='id') | list }}"
        scheme: internet-facing
        state: present
        tags:
          "Name": "{{ prefix_v }}-alb"
          "Project": "{{ prefix_v }}"
        listeners:
          - Protocol: HTTPS
            Port: 443
            SslPolicy: ELBSecurityPolicy-TLS13-1-2-Ext2-PQ-2025-09
            DefaultActions:
              - Type: forward
                TargetGroupArn: "{{ nginx_tg_arn }}"
            Certificates:
              - CertificateArn: "{{ ca_certificate_arn }}"
            Rules:
              - Conditions:
                  - Field: path-pattern
                    Values:
                      - "/locust*"
                Priority: 1
                Actions:
                  - Type: forward
                    TargetGroupArn: "{{ locust_target_group_r.target_group_arn }}"
              - Conditions:
                  - Field: path-pattern
                    Values:
                      - "/admin*"
                Priority: 2
                Actions:
                  - Type: forward
                    TargetGroupArn: "{{ gateway_tg_arn }}"
              - Conditions:
                  - Field: path-pattern
                    Values:
                      - "/pg*"
                Priority: 3
                Actions:
                  - Type: forward
                    TargetGroupArn: "{{ pgadmin_tg_arn }}"
              - Conditions:
                  - Field: path-pattern
                    Values:
                      - "/redis*"
                Priority: 4
                Actions:
                  - Type: forward
                    TargetGroupArn: "{{ redis_commander_tg_arn }}"
      register: alb_r

    - name: Display routing info
      ansible.builtin.debug:
        msg: "ALB routes: /locust -> Locust, /admin -> Gateway, /pg -> pgAdmin, /redis -> Redis Commander, default -> nginx"

    # =========================================================================
    # Configure DNS
    # =========================================================================

    - name: ALB DNS Name is
      ansible.builtin.debug:
        var: alb_r.dns_name

    - name: Wait for ALB DNS to be available
      ansible.builtin.command: dig +short {{ alb_r.dns_name }}
      changed_when: false
      register: alb_dig_r
      retries: 30
      delay: 20
      until: alb_dig_r.stdout is truthy

    - name: Create Route 53 A records for ALB IP addresses
      amazon.aws.route53:
        state: present
        zone: "{{ (mcf_domain | split('.'))[-2:] | join('.') }}"
        record: "{{ prefix_v + '.' + mcf_domain }}"
        type: A
        ttl: 60
        value: "{{ alb_dig_r.stdout | split('\n') }}"
        overwrite: true
        wait: true

    - name: Display Locust UI URL
      ansible.builtin.debug:
        msg: "Locust UI available at: https://{{ prefix_v }}.{{ mcf_domain }}"
