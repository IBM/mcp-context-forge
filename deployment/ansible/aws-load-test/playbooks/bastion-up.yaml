- name: Create Bastion Host
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    ansible_python_interpreter: ../.venv/bin/python
  tasks:
    # Get VPC public subnets
    - name: Get VPC public subnets
      amazon.aws.ec2_vpc_subnet_info:
        region: "{{ region_v }}"
        filters:
          "tag:Project": "{{ prefix_v }}"
          "map-public-ip-on-launch": true
      register: vpc_public_subnet_f

    # Get bastion security group
    - name: Get Bastion Security Group
      amazon.aws.ec2_security_group_info:
        region: "{{ region_v }}"
        filters:
          "tag:Name": "{{ prefix_v }}-bastion-sg"
      register: bastion_sg_f

    # Retreive information on instance_type
    - name: Retrieve information on Instance Type
      ec2_describe_instance_types:
        filters:
          - name: instance-type
            values:
              - "{{ instance_type_v }}"
      register: instance_type_r

    # Select the appropriate AMI for the instacnce_type and region
    - name: Retreive AMI candidates
      amazon.aws.ec2_ami_info:
        owners:
          - amazon
        filters:
          architecture: "{{ instance_type_r.instance_types[0].processor_info.supported_architectures[0] }}"
          name: "ubuntu/images/*/ubuntu-noble-24.04-*-server-*"
      register: amis_r

    # CREATE BASTION INSTANCE
    - name: Creating Bastion Host
      amazon.aws.ec2_instance:
        state: running
        key_name: "{{ keypair_v }}"
        region: "{{ region_v }}"
        instance_type: "{{ instance_type_v }}"
        image:
          id: "{{ amis_r.images[-1].image_id }}"
        wait: true
        wait_timeout: 300
        tags:
          Name: "{{ prefix_v }}-bastion"
          Project: "{{ prefix_v }}"
          Owner: "{{ owner_v }}"
          Role: "bastion"
        exact_count: 1
        filters:
          "tag:Name": "{{ prefix_v }}-bastion"
          "instance-state-name": "running"
        network_interfaces:
          - assign_public_ip: true
            groups:
              - "{{ bastion_sg_f.security_groups[0].group_id }}"
            subnet_id: "{{ vpc_public_subnet_f.subnets[0].id }}"
      register: bastion_host_r

    - name: Refresh inventory
      ansible.builtin.meta: refresh_inventory

    - name: Wait for SSH to become available on bastion
      ansible.builtin.wait_for:
        host: "{{ bastion_host_r.instances[0].public_ip_address }}"
        port: 22
        delay: 10
        timeout: 300
        state: started

- name: Configure bastion for load testing
  hosts: "_bastion"
  become: true
  tasks:
    - name: Wait for connection
      ansible.builtin.wait_for_connection:
        timeout: 300

    - name: Install Python and dependencies
      ansible.builtin.apt:
        name:
          - python3-pip
          - python3-venv
          - python3-dev
          - build-essential
          - unzip
          - jq
        state: present
        update_cache: true

    # =========================================================================
    # AWS CLI Installation
    # =========================================================================

    - name: Check if AWS CLI is installed
      ansible.builtin.command: aws --version
      register: aws_cli_check
      failed_when: false
      changed_when: false

    - name: Download AWS CLI installer
      ansible.builtin.get_url:
        url: https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip
        dest: /tmp/awscliv2.zip
        mode: '0644'
      when: aws_cli_check.rc != 0

    - name: Unzip AWS CLI installer
      ansible.builtin.unarchive:
        src: /tmp/awscliv2.zip
        dest: /tmp
        remote_src: true
      when: aws_cli_check.rc != 0

    - name: Install AWS CLI
      ansible.builtin.command: /tmp/aws/install
      when: aws_cli_check.rc != 0

    # =========================================================================
    # Docker Installation
    # =========================================================================

    - name: Install Docker prerequisites
      ansible.builtin.apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'

    - name: Add Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: '0644'

    - name: Add Docker repository
      ansible.builtin.apt_repository:
        repo: "deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker packages
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

    - name: Add ubuntu user to docker group
      ansible.builtin.user:
        name: ubuntu
        groups: docker
        append: true

    - name: Reset SSH connection for group change to take effect
      ansible.builtin.meta: reset_connection

    - name: Enable and start Docker service
      ansible.builtin.systemd:
        name: docker
        enabled: true
        state: started

    # =========================================================================
    # Locust Installation
    # =========================================================================

    - name: Create Locust directory
      ansible.builtin.file:
        path: /home/ubuntu/locust
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Create Locust virtual environment
      ansible.builtin.pip:
        virtualenv: /home/ubuntu/.locust-venv
        virtualenv_command: python3 -m venv
        name:
          - locust
          - httpx
          - websockets

    - name: Copy Locust test script
      ansible.builtin.template:
        src: ../templates/locustfile.py.j2
        dest: /home/ubuntu/locust/locustfile.py
        owner: ubuntu
        group: ubuntu
        mode: '0644'

    - name: Copy Locust systemd service
      ansible.builtin.template:
        src: ../templates/locust.service.j2
        dest: /etc/systemd/system/locust.service
        mode: '0644'
      notify: Reload systemd

    - name: Enable and start Locust service
      ansible.builtin.systemd:
        name: locust
        enabled: true
        state: started
        daemon_reload: true

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: true
