---
- name: Set up security groups
  hosts: localhost
  connection: local
  gather_facts: false
  vars:
    ansible_python_interpreter: ../.venv/bin/python
  tasks:
    # Get VPC information
    - name: Get VPC info
      amazon.aws.ec2_vpc_net_info:
        region: "{{ region_v }}"
        filters:
          "tag:Name": "{{ prefix_v }}-vpc"
      register: vpc_info_r

    - name: Set VPC ID fact
      ansible.builtin.set_fact:
        vpc_id_f: "{{ vpc_info_r.vpcs[0].id }}"

    # Find my public IPv4 and IPv6 addresses for bastion and ALB access
    - name: Find my public IPv4 address
      ansible.builtin.uri:
        url: https://ipv4.icanhazip.com
        return_content: true
        timeout: 5
      register: ipv4_response
      ignore_errors: true

    - name: Find my public IPv6 address
      ansible.builtin.uri:
        url: https://ipv6.icanhazip.com
        return_content: true
        timeout: 5
      register: ipv6_response
      ignore_errors: true

    - name: Set IP facts
      ansible.builtin.set_fact:
        my_ipv4: "{{ ipv4_response.content | default('') | trim }}"
        my_ipv6: "{{ ipv6_response.content | default('') | trim }}"
        has_ipv4: "{{ ipv4_response is success and ipv4_response.content | default('') | trim | length > 0 }}"
        has_ipv6: "{{ ipv6_response is success and ipv6_response.content | default('') | trim | length > 0 }}"

    - name: Build security group rules list
      ansible.builtin.set_fact:
        bastion_ssh_rules: >-
          {{
            (has_ipv4 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_ip': my_ipv4 + '/32'},
               {'proto': 'tcp', 'from_port': 8089, 'to_port': 8089, 'cidr_ip': my_ipv4 + '/32'}],
              []
            ) +
            (has_ipv6 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 22, 'to_port': 22, 'cidr_ipv6': my_ipv6 + '/128'},
               {'proto': 'tcp', 'from_port': 8089, 'to_port': 8089, 'cidr_ipv6': my_ipv6 + '/128'}],
              []
            )
          }}
        alb_rules: >-
          {{
            (has_ipv4 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_ip': my_ipv4 + '/32'},
               {'proto': 'tcp', 'from_port': 443, 'to_port': 443, 'cidr_ip': my_ipv4 + '/32'}],
              []
            ) +
            (has_ipv6 | bool) | ternary(
              [{'proto': 'tcp', 'from_port': 80, 'to_port': 80, 'cidr_ipv6': my_ipv6 + '/128'},
               {'proto': 'tcp', 'from_port': 443, 'to_port': 443, 'cidr_ipv6': my_ipv6 + '/128'}],
              []
            )
          }}

    - name: Display detected IPs
      ansible.builtin.debug:
        msg: "IPv4: {{ my_ipv4 | default('none') }}, IPv6: {{ my_ipv6 | default('none') }}"

    # BASTION SECURITY GROUP (no dependencies)
    - name: Create Security Group for bastion host
      amazon.aws.ec2_security_group:
        name: "{{ prefix_v }}-bastion-sg"
        description: Allow SSH and Locust from my IP (IPv4 and IPv6)
        region: "{{ region_v }}"
        vpc_id: "{{ vpc_id_f }}"
        tags:
          "Name": "{{ prefix_v }}-bastion-sg"
        rules: "{{ bastion_ssh_rules }}"
      register: bastion_sg_r

    # ALB SECURITY GROUP (no dependencies - create before ECS SG)
    - name: Create Security Group for ALB
      amazon.aws.ec2_security_group:
        name: "{{ prefix_v }}-alb-sg"
        description: Allow HTTP/HTTPS from my IP (IPv4 and IPv6)
        region: "{{ region_v }}"
        vpc_id: "{{ vpc_id_f }}"
        tags:
          "Name": "{{ prefix_v }}-alb-sg"
        rules: "{{ alb_rules }}"
      register: alb_sg_r

    # ECS FARGATE TASKS SECURITY GROUP
    # This is for Fargate tasks running in the cluster
    - name: Create Security Group for ECS Fargate tasks
      amazon.aws.ec2_security_group:
        name: "{{ prefix_v }}-ecs-tasks-sg"
        description: >-
          Security group for ECS Fargate tasks - allows ALB and inter-service traffic
        region: "{{ region_v }}"
        vpc_id: "{{ vpc_id_f }}"
        tags:
          "Name": "{{ prefix_v }}-ecs-tasks-sg"
        rules:
          # Allow traffic from ALB to nginx and pgAdmin (port 80)
          - proto: tcp
            from_port: 80
            to_port: 80
            group_id: "{{ alb_sg_r.group_id }}"
          # Allow traffic from ALB to gateway (port 4444) for /admin route
          - proto: tcp
            from_port: 4444
            to_port: 4444
            group_id: "{{ alb_sg_r.group_id }}"
          # Allow traffic from ALB to redis-commander (port 8081) for /redis route
          - proto: tcp
            from_port: 8081
            to_port: 8081
            group_id: "{{ alb_sg_r.group_id }}"
          # Allow inter-service traffic via Service Connect
          # (nginx -> gateway, gateway -> redis)
          - proto: tcp
            from_port: 80
            to_port: 80
            group_name: "{{ prefix_v }}-ecs-tasks-sg"
          - proto: tcp
            from_port: 4444
            to_port: 4444
            group_name: "{{ prefix_v }}-ecs-tasks-sg"
          - proto: tcp
            from_port: 6379
            to_port: 6379
            group_name: "{{ prefix_v }}-ecs-tasks-sg"
          - proto: tcp
            from_port: 8081
            to_port: 8081
            group_name: "{{ prefix_v }}-ecs-tasks-sg"
          # Allow bastion to access containers for debugging via ECS Exec
          - proto: tcp
            from_port: 80
            to_port: 80
            group_id: "{{ bastion_sg_r.group_id }}"
          - proto: tcp
            from_port: 4444
            to_port: 4444
            group_id: "{{ bastion_sg_r.group_id }}"
          - proto: tcp
            from_port: 8081
            to_port: 8081
            group_id: "{{ bastion_sg_r.group_id }}"
      register: ecs_ec2_sg_r

    # AURORA POSTGRESQL SECURITY GROUP
    - name: Create Security Group for Aurora PostgreSQL
      amazon.aws.ec2_security_group:
        name: "{{ prefix_v }}-aurora-postgresql-sg"
        description: Allow port 5432 from the bastion server and ECS Fargate tasks
        region: "{{ region_v }}"
        vpc_id: "{{ vpc_id_f }}"
        tags:
          "Name": "{{ prefix_v }}-aurora-postgresql-sg"
        rules:
          - proto: tcp
            from_port: 5432
            to_port: 5432
            group_id: "{{ bastion_sg_r.group_id }}"
          - proto: tcp
            from_port: 5432
            to_port: 5432
            group_id: "{{ ecs_ec2_sg_r.group_id }}"
      register: aurora_sg_r

    # ELASTICACHE SECURITY GROUP
    - name: Create Security Group for ElastiCache
      amazon.aws.ec2_security_group:
        name: "{{ prefix_v }}-elasticache-sg"
        description: Allow port 6379 from ECS Fargate tasks
        region: "{{ region_v }}"
        vpc_id: "{{ vpc_id_f }}"
        tags:
          "Name": "{{ prefix_v }}-elasticache-sg"
        rules:
          - proto: tcp
            from_port: 6379
            to_port: 6379
            group_id: "{{ ecs_ec2_sg_r.group_id }}"
      register: elasticache_sg_r
