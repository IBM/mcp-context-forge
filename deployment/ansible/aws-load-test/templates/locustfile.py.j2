# -*- coding: utf-8 -*-
"""Locust load testing for MCP ContextForge AWS deployment.

This is a simplified locustfile for AWS load testing.
For the full test suite, see tests/loadtest/locustfile.py in the main repository.

Access the Locust UI via SSH tunnel:
    ssh -L 8089:localhost:8089 ubuntu@<bastion-ip>
    Then open http://localhost:8089 in your browser.
"""

import logging
import os
import random
from locust import between, task
from locust.contrib.fasthttp import FastHttpUser

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Configuration
BEARER_TOKEN = os.environ.get("MCPGATEWAY_BEARER_TOKEN", "")


class MCFUser(FastHttpUser):
    """Standard MCP ContextForge user simulating typical usage patterns."""

    wait_time = between(0.1, 0.5)
    weight = 100

    def on_start(self):
        """Set up authentication headers."""
        self.headers = {}
        if BEARER_TOKEN:
            self.headers["Authorization"] = f"Bearer {BEARER_TOKEN}"

    @task(10)
    def health_check(self):
        """Check gateway health endpoint."""
        self.client.get("/health", headers=self.headers)

    @task(5)
    def list_tools(self):
        """List available MCP tools."""
        self.client.get("/api/v1/tools", headers=self.headers)

    @task(5)
    def list_servers(self):
        """List registered MCP servers."""
        self.client.get("/api/v1/servers", headers=self.headers)

    @task(3)
    def list_gateways(self):
        """List configured gateways."""
        self.client.get("/api/v1/gateways", headers=self.headers)

    @task(2)
    def list_prompts(self):
        """List available prompts."""
        self.client.get("/api/v1/prompts", headers=self.headers)

    @task(2)
    def list_resources(self):
        """List available resources."""
        self.client.get("/api/v1/resources", headers=self.headers)


class FastMCFUser(FastHttpUser):
    """High-throughput user for stress testing."""

    wait_time = between(0.01, 0.05)
    weight = 50

    def on_start(self):
        """Set up authentication headers."""
        self.headers = {}
        if BEARER_TOKEN:
            self.headers["Authorization"] = f"Bearer {BEARER_TOKEN}"

    @task
    def rapid_health_check(self):
        """Rapid health check for stress testing."""
        self.client.get("/health", headers=self.headers)


class AdminUser(FastHttpUser):
    """Admin user simulating administrative operations."""

    wait_time = between(1, 3)
    weight = 10

    def on_start(self):
        """Set up authentication headers."""
        self.headers = {}
        if BEARER_TOKEN:
            self.headers["Authorization"] = f"Bearer {BEARER_TOKEN}"

    @task(5)
    def list_tools(self):
        """List all tools."""
        self.client.get("/api/v1/tools", headers=self.headers)

    @task(3)
    def list_servers_detailed(self):
        """List servers with details."""
        self.client.get("/api/v1/servers", headers=self.headers)

    @task(2)
    def get_metrics(self):
        """Get Prometheus metrics."""
        self.client.get("/metrics", headers=self.headers)
