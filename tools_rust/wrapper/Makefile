# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
#   ü¶Ä ContextForge STDIO Wrapper (Rust)
#   High-performance stdio-to-HTTP bridge for ContextForge AI Gateway
# ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
#
# SPDX-License-Identifier: Apache-2.0
# Usage: run `make` or `make help` to view available targets
#
# help: ü¶Ä ContextForge STDIO Wrapper (Rust)
#
# ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
SHELL := /bin/bash
.SHELLFLAGS := -eu -o pipefail -c
.DEFAULT_GOAL := help

# Binary name
BIN := contextforge-stdio-wrapper

# =============================================================================
# üìñ DYNAMIC HELP
# =============================================================================
.PHONY: help
help:
	@grep "^# help\:" Makefile | grep -v grep | sed 's/\# help\: //' | sed 's/\# help\://'

# =============================================================================
# üî® BUILD
# =============================================================================
# help: üî® BUILD
# help: build                - Build debug version
# help: build-release        - Build optimized release version (fat LTO)
.PHONY: build build-release
build:
	@echo "üî®  Building debug..."
	@cargo build

build-release:
	@echo "üî®  Building release..."
	@cargo build --release

# =============================================================================
# üß™ TEST
# =============================================================================
# help: üß™ TEST
# help: test                 - Run all tests
# help: test-verbose         - Run tests with verbose output
.PHONY: test test-verbose
test:
	@echo "üß™  Running tests..."
	@cargo test

test-verbose:
	@echo "üß™  Running tests (verbose)..."
	@cargo test -- --nocapture

# =============================================================================
# ‚úÖ CODE QUALITY
# =============================================================================
# help: ‚úÖ CODE QUALITY
# help: check                - Run all checks (format, lint, test)
# help: fmt                  - Format code with rustfmt
# help: fmt-check            - Check code formatting (CI mode)
# help: clippy               - Run clippy linter
# help: clippy-pedantic      - Run clippy with pedantic lints
# help: clippy-fix           - Run clippy and auto-fix issues
.PHONY: check fmt fmt-check clippy clippy-pedantic clippy-fix
check: fmt clippy test
	@echo "‚úÖ  All checks passed!"

fmt:
	@echo "‚úèÔ∏è   Formatting code..."
	@cargo fmt --all

fmt-check:
	@echo "‚úèÔ∏è   Checking format..."
	@cargo fmt --all -- --check

clippy:
	@echo "üìé  Running clippy..."
	@cargo clippy --all-targets -- -D warnings

clippy-pedantic:
	@echo "üìé  Running clippy (pedantic)..."
	@cargo clippy --all-targets -- -W clippy::pedantic

clippy-fix:
	@echo "üìé  Running clippy --fix..."
	@cargo clippy --all-targets --fix --allow-dirty -- -W clippy::pedantic

# =============================================================================
# üìä COVERAGE
# =============================================================================
# help: üìä COVERAGE
# help: coverage             - Generate HTML code coverage report
# help: coverage-open        - Generate and open coverage report in browser
# help: coverage-summary     - Show coverage summary in terminal
.PHONY: coverage coverage-open coverage-summary
coverage:
	@echo "üìä  Generating coverage report..."
	@command -v cargo-llvm-cov >/dev/null 2>&1 || { echo "‚¨áÔ∏è   Installing cargo-llvm-cov..."; cargo install cargo-llvm-cov; }
	@rustup component add llvm-tools-preview 2>/dev/null || true
	@cargo llvm-cov --html
	@echo "üìÅ  Report: target/llvm-cov/html/index.html"

coverage-open: coverage
	@command -v xdg-open >/dev/null 2>&1 && xdg-open target/llvm-cov/html/index.html || open target/llvm-cov/html/index.html

coverage-summary:
	@command -v cargo-llvm-cov >/dev/null 2>&1 || { echo "‚¨áÔ∏è   Installing cargo-llvm-cov..."; cargo install cargo-llvm-cov; }
	@cargo llvm-cov

# =============================================================================
# üîê SECURITY & LICENSES
# =============================================================================
# help: üîê SECURITY & LICENSES
# help: licenses             - Check dependency licenses (deny.toml)
# help: audit                - Run security audit on dependencies
.PHONY: licenses audit
licenses:
	@echo "üîê  Checking licenses..."
	@command -v cargo-deny >/dev/null 2>&1 || { echo "‚¨áÔ∏è   Installing cargo-deny..."; cargo install cargo-deny; }
	@cargo deny check licenses

audit:
	@echo "üîê  Running security audit..."
	@command -v cargo-audit >/dev/null 2>&1 || { echo "‚¨áÔ∏è   Installing cargo-audit..."; cargo install cargo-audit; }
	@cargo audit

# =============================================================================
# üìñ DOCUMENTATION
# =============================================================================
# help: üìñ DOCUMENTATION
# help: doc                  - Build Rust documentation
# help: doc-open             - Build and open documentation in browser
.PHONY: doc doc-open
doc:
	@echo "üìñ  Building docs..."
	@cargo doc --no-deps --document-private-items

doc-open: doc
	@cargo doc --no-deps --document-private-items --open

# =============================================================================
# üì¶ DEPENDENCY MANAGEMENT
# =============================================================================
# help: üì¶ DEPENDENCY MANAGEMENT
# help: deps-tree            - Show dependency tree
# help: deps-outdated        - Check for outdated dependencies
# help: deps-update          - Update dependencies to latest compatible versions
.PHONY: deps-tree deps-outdated deps-update
deps-tree:
	@cargo tree --depth 1

deps-outdated:
	@command -v cargo-outdated >/dev/null 2>&1 || { echo "‚¨áÔ∏è   Installing cargo-outdated..."; cargo install cargo-outdated; }
	@cargo outdated

deps-update:
	@echo "üì¶  Updating dependencies..."
	@cargo update
	@echo "üí°  Review changes: git diff Cargo.lock"

# =============================================================================
# üßπ CLEAN
# =============================================================================
# help: üßπ CLEAN
# help: clean                - Remove build artifacts
.PHONY: clean
clean:
	@echo "üßπ  Cleaning..."
	@cargo clean

# =============================================================================
# üîÑ DEVELOPMENT WORKFLOWS
# =============================================================================
# help: üîÑ DEVELOPMENT WORKFLOWS
# help: dev-cycle            - Quick dev cycle (format, lint, test)
# help: ci                   - CI pipeline (format check, lint, test, licenses)
# help: watch                - Watch for changes and run tests automatically
.PHONY: dev-cycle ci watch
dev-cycle: fmt clippy test
	@echo "‚úÖ  Dev cycle passed!"

ci: fmt-check clippy test licenses
	@echo "‚úÖ  CI checks passed!"

watch:
	@command -v cargo-watch >/dev/null 2>&1 || { echo "‚¨áÔ∏è   Installing cargo-watch..."; cargo install cargo-watch; }
	@cargo watch -x test

# =============================================================================
# ‚ÑπÔ∏è  INFO
# =============================================================================
# help: ‚ÑπÔ∏è  INFO
# help: info                 - Show build and project information
# help: stats                - Show code statistics
.PHONY: info stats
info:
	@echo "‚ÑπÔ∏è   Build Information:"
	@echo "  Rust:    $$(rustc --version)"
	@echo "  Cargo:   $$(cargo --version)"
	@echo ""
	@echo "‚ÑπÔ∏è   Project:"
	@echo "  Name:    $(BIN)"
	@echo "  Version: $$(grep '^version' Cargo.toml | head -1 | cut -d'"' -f2)"
	@echo "  License: $$(grep '^license' Cargo.toml | head -1 | cut -d'"' -f2)"

stats:
	@echo "üìà  Code Statistics:"
	@echo "  Source files: $$(find src -name '*.rs' | wc -l)"
	@echo "  Source lines: $$(find src -name '*.rs' -exec cat {} + | wc -l)"
	@echo "  Test files:   $$(find tests -name '*.rs' | wc -l)"
	@echo "  Test lines:   $$(find tests -name '*.rs' -exec cat {} + | wc -l)"
