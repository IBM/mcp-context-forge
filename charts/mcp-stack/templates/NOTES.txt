{{- /*
   NOTES.txt for the "mcp-stack" Helm chart
   • Rendered after every install/upgrade.
   • Surfaces endpoints, credentials and helper commands so you can
     start interacting with the stack right away.
*/ -}}

{{- $ns       := .Release.Namespace }}
{{- $fullName := include "mcp-stack.fullname" . }}

{{- /* -----------------------------------------------------------------
      Resource names (keep in sync with ./_helpers.tpl)
------------------------------------------------------------------*/ -}}
{{- $gatewaySvc  := printf "%s-mcpgateway"            $fullName }}
{{- $ftSvc       := printf "%s-mcp-fast-time-server"  $fullName }}
{{- $postgresSvc := printf "%s-postgres"              $fullName }}
{{- $redisSvc    := printf "%s-redis"                 $fullName }}
{{- $pgadminSvc  := printf "%s-pgadmin"               $fullName }}

{{- $gwSecret := printf "%s-gateway-secret" $fullName }}
{{- $pgSecret := include "mcp-stack.postgresSecretName" . }}

{{- /* -----------------------------------------------------------------
      Pull secret values so we can display them
------------------------------------------------------------------*/ -}}
{{- $gwSecObj := lookup "v1" "Secret" $ns $gwSecret }}
{{- $pgSecObj := lookup "v1" "Secret" $ns $pgSecret }}

{{- $basicAuthPass := "" }}
{{- $jwtKey        := "" }}
{{- if $gwSecObj }}
  {{- $basicAuthPass = index $gwSecObj.data "BASIC_AUTH_PASSWORD" | b64dec }}
  {{- $jwtKey        = index $gwSecObj.data "JWT_SECRET_KEY"      | b64dec }}
{{- end }}

{{- /* ── Postgres password ─────────────────────────────── */}}
{{- $pgSec := lookup "v1" "Secret" $ns $pgSecret }}
{{- $pgPass := "<secret-not-yet-created>" }}
{{- if $pgSec }}
  {{- $pgPass = (index $pgSec.data "POSTGRES_PASSWORD" | b64dec) }}
{{- end }}

{{- /* -----------------------------------------------------------------
      Convenience shorthands
------------------------------------------------------------------*/ -}}
{{- $gwPort      := .Values.mcpContextForge.service.port | default 80 }}
{{- $pgPort      := .Values.postgres.service.port        | default 5432 }}
{{- $redisPort   := .Values.redis.service.port           | default 6379 }}
{{- $pgAdminPort := .Values.pgadmin.service.port         | default 80 }}

🎉  **{{ .Chart.Name }}** has been successfully deployed to namespace **{{ $ns }}**!

{{- /* ════════════  MCP Gateway  ════════════ */}}
🔗 **MCP Gateway**
{{- if .Values.mcpContextForge.ingress.enabled }}
  • Ingress URL  : https://{{ .Values.mcpContextForge.ingress.host }}{{ .Values.mcpContextForge.ingress.path | default "/" }}
{{- else }}
  • Service URL  : http://{{ $gatewaySvc }}.{{ $ns }}.svc.cluster.local:{{ $gwPort }}
{{- end }}
  • Basic-Auth :
      user      = {{ .Values.mcpContextForge.secret.BASIC_AUTH_USER }}
      password  = {{ .Values.mcpContextForge.secret.BASIC_AUTH_PASSWORD | default "<set-in-values>" }}
      `kubectl -n {{ $ns }} get secret {{ $gwSecret }} -o jsonpath="{.data.BASIC_AUTH_PASSWORD}" | base64 -d`
  • JWT signing key (JWT_SECRET_KEY) = {{ $jwtKey }}
      `kubectl -n {{ $ns }} get secret {{ $gwSecret }} -o jsonpath="{.data.JWT_SECRET_KEY}" | base64 -d`
  • Port-forward : `kubectl -n {{ $ns }} port-forward svc/{{ $gatewaySvc }} 4444:{{ $gwPort }}`

{{- /* ════════════  Fast-Time-Server  ════════════ */}}
🔗 **Fast-Time-Server (SSE)**
  • Cluster URL  : http://{{ $ftSvc }}.{{ $ns }}.svc.cluster.local
  • Via Gateway  : {{- if .Values.mcpContextForge.ingress.enabled }} https://{{ .Values.mcpContextForge.ingress.host }}/fast-time {{- else }} http://localhost:4444/fast-time {{- end }}

{{- /* ════════════  Datastores  ════════════ */}}
💾 **Postgres**
  • Host / Port  : {{ $postgresSvc }}.{{ $ns }}.svc.cluster.local:{{ $pgPort }}
  • DB           : {{ .Values.postgres.credentials.database }}
  • User         : {{ .Values.postgres.credentials.user }}
  • Password     : {{ .Values.postgres.credentials.password | default "<set-in-values>" }}
      `kubectl -n {{ $ns }} get secret {{ $pgSecret }} -o jsonpath="{.data.POSTGRES_PASSWORD}" | base64 -d`

🔑 **Redis**
  • Host / Port  : {{ $redisSvc }}.{{ $ns }}.svc.cluster.local:{{ $redisPort }}

📊 **PGAdmin**
  • URL          : http://{{ $pgadminSvc }}.{{ $ns }}.svc.cluster.local:{{ $pgAdminPort }}
  • Login        : {{ .Values.pgadmin.env.email }} / (same Postgres password)

{{- /* ════════════  Quick-start  ════════════ */}}
🚀 **Quick-start**

```bash
# 1) Forward the Gateway locally (skip if using ingress):
kubectl -n {{ $ns }} port-forward svc/{{ $gatewaySvc }} 4444:{{ $gwPort }} &

# 2) Obtain a JWT via Basic-Auth (requires 'jq'): # TODO not yet implemented use jwt tool manually
export GW_TOKEN=$(curl -s -u '{{ .Values.mcpContextForge.secret.BASIC_AUTH_USER }}:{{ $basicAuthPass }}' \
  -X POST http://localhost:4444/auth/login | jq -r '.access_token')

# 3) Register the Fast-Time-Server with the Gateway:
curl -s -X POST \
     -H "Authorization: Bearer $GW_TOKEN" \
     -H "Content-Type: application/json" \
     -d '{"name":"local_time","url":"http://{{ $ftSvc }}.{{ $ns }}.svc.cluster.local/sse"}' \
     http://localhost:4444/gateways
```

📚 **Further reading**
* [https://ibm.github.io/mcp-context-forge/deployment/helm/](https://ibm.github.io/mcp-context-forge/deployment/helm/)
* [https://ibm.github.io/mcp-context-forge/testing/basic/](https://ibm.github.io/mcp-context-forge/testing/basic/)
