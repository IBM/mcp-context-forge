<!-- Batch Runner - Run Multiple Test Cases -->
<div class="space-y-6" x-data="batchRunner()">
  <!-- Header -->
  <div class="flex justify-between items-center">
    <div>
      <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
        Batch Testing
      </h2>
      <p class="mt-1 text-sm text-gray-600 dark:text-gray-400">
        Run multiple test cases and view aggregated results
      </p>
    </div>
    <button
      hx-get="{{ root_path }}/admin/sandbox/partial"
      hx-target="#sandbox-panel"
      hx-swap="innerHTML"
      class="inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
    >
      <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
      </svg>
      Back to Dashboard
    </button>
  </div>

  <!-- Configuration Form -->
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Batch Configuration
      </h3>
    </div>
    
    <form id="batchForm" class="p-6 space-y-6">
      <!-- Policy Draft Selection -->
      <div>
        <label for="batchPolicyDraft" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Policy Draft <span class="text-red-500">*</span>
        </label>
        <select
          id="batchPolicyDraft"
          x-model="policyDraft"
          required
          class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
        >
          <option value="">Select a policy draft...</option>
          <option value="draft-permissive">Draft: Permissive Policy</option>
          <option value="draft-restrictive">Draft: Restrictive Policy</option>
          <option value="draft-balanced">Draft: Balanced Policy</option>
        </select>
      </div>

      <!-- Test Suite Selection (Future) -->
      <div>
        <label for="testSuite" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
          Test Suite (Optional)
        </label>
        <select
          id="testSuite"
          x-model="testSuite"
          class="block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white"
        >
          <option value="">Load from saved test suite...</option>
          <option value="suite-1">Suite: Developer Access Tests</option>
          <option value="suite-2">Suite: Admin Permissions</option>
          <option value="suite-3">Suite: Resource Access</option>
        </select>
      </div>

      <!-- Execution Options -->
      <div class="flex items-center space-x-6">
        <div class="flex items-center">
          <input
            id="parallelExecution"
            type="checkbox"
            x-model="parallelExecution"
            class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
          />
          <label for="parallelExecution" class="ml-2 block text-sm text-gray-700 dark:text-gray-300">
            Parallel Execution (faster)
          </label>
        </div>
      </div>
    </form>
  </div>

  <!-- Quick Test Cases Builder -->
  <div class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Test Cases
      </h3>
    </div>

    <div class="p-6 space-y-4">
      <!-- Test Cases List -->
      <div class="space-y-3">
        <template x-for="(testCase, index) in testCases" :key="index">
          <div class="flex items-center justify-between p-4 border border-gray-200 dark:border-gray-700 rounded-lg">
            <div class="flex-1">
              <div class="flex items-center space-x-4">
                <input
                  type="checkbox"
                  x-model="testCase.selected"
                  class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                />
                <div>
                  <p class="text-sm font-medium text-gray-900 dark:text-white">
                    <span x-text="testCase.subject"></span> → 
                    <span x-text="testCase.action"></span> → 
                    <span x-text="testCase.resource"></span>
                  </p>
                  <p class="text-xs text-gray-500 dark:text-gray-400">
                    Expected: <span x-text="testCase.expected" class="font-semibold"></span>
                  </p>
                </div>
              </div>
            </div>
            <button
              @click="removeTestCase(index)"
              class="text-red-600 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300"
            >
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
            </button>
          </div>
        </template>

        <!-- Empty State -->
        <div x-show="testCases.length === 0" class="text-center py-8">
          <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">
            No test cases added yet. Use the form below to add test cases.
          </p>
        </div>
      </div>

      <!-- Add Test Case Form -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-3">Add Test Case</h4>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <input
            type="text"
            x-model="newTest.subject"
            placeholder="user@example.com"
            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
          />
          <input
            type="text"
            x-model="newTest.action"
            placeholder="tools.invoke"
            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
          />
          <input
            type="text"
            x-model="newTest.resource"
            placeholder="tool:db-query"
            class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
          />
          <div class="flex space-x-2">
            <select
              x-model="newTest.expected"
              class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm"
            >
              <option value="ALLOW">ALLOW</option>
              <option value="DENY">DENY</option>
            </select>
            <button
              @click="addTestCase()"
              class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
            >
              Add
            </button>
          </div>
        </div>
      </div>

      <!-- Action Buttons -->
      <div class="flex justify-between items-center pt-4 border-t border-gray-200 dark:border-gray-700">
        <div class="text-sm text-gray-600 dark:text-gray-400">
          <span x-text="selectedCount()"></span> of <span x-text="testCases.length"></span> selected
        </div>
        <div class="flex space-x-3">
          <button
            @click="selectAll()"
            type="button"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-sm font-medium text-gray-700 dark:text-gray-200 bg-white dark:bg-gray-800 hover:bg-gray-50 dark:hover:bg-gray-700"
          >
            Select All
          </button>
          <button
            @click="runBatch()"
            :disabled="selectedCount() === 0 || !policyDraft"
            type="button"
            class="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50 disabled:cursor-not-allowed"
          >
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 10l-2 1m0 0l-2-1m2 1v2.5M20 7l-2 1m2-1l-2-1m2 1v2.5M14 4l-2-1-2 1M4 7l2-1M4 7l2 1M4 7v2.5M12 21l-2-1m2 1l2-1m-2 1v-2.5M6 18l-2-1v-2.5M18 18l2-1v-2.5" />
            </svg>
            Run Batch (<span x-text="selectedCount()"></span>)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Results Section -->
  <div x-show="results" id="batchResults" class="bg-white dark:bg-gray-800 shadow rounded-lg">
    <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
      <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
        Batch Results
      </h3>
    </div>

    <div class="p-6 space-y-6">
      <!-- Summary Stats -->
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">Total Tests</p>
          <p class="text-3xl font-bold text-gray-900 dark:text-white" x-text="results?.total || 0"></p>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">Passed</p>
          <p class="text-3xl font-bold text-green-600" x-text="results?.passed || 0"></p>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">Failed</p>
          <p class="text-3xl font-bold text-red-600" x-text="results?.failed || 0"></p>
        </div>
        <div class="text-center">
          <p class="text-sm text-gray-500 dark:text-gray-400">Pass Rate</p>
          <p class="text-3xl font-bold text-blue-600" x-text="(results?.passRate || 0) + '%'"></p>
        </div>
      </div>

      <!-- Detailed Results Table -->
      <div class="border-t border-gray-200 dark:border-gray-700 pt-6">
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-50 dark:bg-gray-900">
              <tr>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Subject
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Action
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Resource
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Expected
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Actual
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Result
                </th>
                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">
                  Time
                </th>
              </tr>
            </thead>
            <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
              <template x-for="(result, index) in results?.details || []" :key="index">
                <tr>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900 dark:text-white" x-text="result.subject"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400" x-text="result.action"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400" x-text="result.resource"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400" x-text="result.expected"></td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400" x-text="result.actual"></td>
                  <td class="px-6 py-4 whitespace-nowrap">
                    <span
                      :class="result.passed ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200'"
                      class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full"
                      x-text="result.passed ? 'PASSED' : 'FAILED'"
                    ></span>
                  </td>
                  <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-600 dark:text-gray-400">
                    <span x-text="result.time"></span>ms
                  </td>
                </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Alpine.js Component -->
<script>
function batchRunner() {
  return {
    policyDraft: '',
    testSuite: '',
    parallelExecution: true,
    testCases: [
      // Sample test cases
      { selected: true, subject: 'developer@example.com', action: 'tools.invoke', resource: 'tool:db-query', expected: 'ALLOW' },
      { selected: true, subject: 'admin@example.com', action: 'tools.delete', resource: 'tool:cleanup', expected: 'ALLOW' },
      { selected: true, subject: 'viewer@example.com', action: 'tools.invoke', resource: 'tool:db-query', expected: 'DENY' },
    ],
    newTest: {
      subject: '',
      action: '',
      resource: '',
      expected: 'ALLOW'
    },
    results: null,

    selectedCount() {
      return this.testCases.filter(tc => tc.selected).length;
    },

    selectAll() {
      this.testCases.forEach(tc => tc.selected = true);
    },

    addTestCase() {
      if (this.newTest.subject && this.newTest.action && this.newTest.resource) {
        this.testCases.push({
          selected: true,
          subject: this.newTest.subject,
          action: this.newTest.action,
          resource: this.newTest.resource,
          expected: this.newTest.expected
        });
        // Reset form
        this.newTest = { subject: '', action: '', resource: '', expected: 'ALLOW' };
      }
    },

    removeTestCase(index) {
      this.testCases.splice(index, 1);
    },

    async runBatch() {
      const selected = this.testCases.filter(tc => tc.selected);
      
      // Mock results for now
      // TODO: Replace with actual API call to /sandbox/batch
      this.results = {
        total: selected.length,
        passed: Math.floor(selected.length * 0.8),
        failed: Math.ceil(selected.length * 0.2),
        passRate: 80,
        details: selected.map(tc => ({
          subject: tc.subject,
          action: tc.action,
          resource: tc.resource,
          expected: tc.expected,
          actual: tc.expected, // Mock: assume most pass
          passed: Math.random() > 0.2,
          time: (Math.random() * 100 + 20).toFixed(1)
        }))
      };

      // Scroll to results
      setTimeout(() => {
        document.getElementById('batchResults')?.scrollIntoView({ behavior: 'smooth' });
      }, 100);
    }
  };
}
</script>
