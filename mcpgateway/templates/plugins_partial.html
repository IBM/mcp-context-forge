<!-- htmlhint doctype-first:false -->
<div class="space-y-6" x-data="{
  activePluginTab: 'routing',
  routingLoaded: false,
  async loadRoutingRules() {
    if (this.routingLoaded) return;
    try {
      const response = await fetch('{{ root_path }}/admin/plugin-routing/rules');
      const html = await response.text();
      document.getElementById('routing-rules-list').innerHTML = html;
      this.routingLoaded = true;
    } catch (e) {
      console.error('Failed to load routing rules:', e);
    }
  },
  init() {
    this.$watch('activePluginTab', (value) => {
      if (value === 'routing') {
        this.$nextTick(() => this.loadRoutingRules());
      }
    });
    // Load immediately if routing is the default tab
    if (this.activePluginTab === 'routing') {
      this.$nextTick(() => this.loadRoutingRules());
    }
  }
}">
  {% if not plugins_enabled %}
  <div
    class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded mb-4"
  >
    <p class="font-bold">Plugins are currently disabled</p>
    <p class="text-sm">
      Set PLUGINS_ENABLED=true in your environment to enable plugin
      functionality.
    </p>
  </div>
  {% else %}
  <!-- Sub-tab Navigation -->
  <div class="border-b border-gray-200 dark:border-gray-700">
    <nav class="-mb-px flex space-x-8">
      <button
        @click="activePluginTab = 'routing'"
        :class="activePluginTab === 'routing' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 hover:border-gray-300'"
        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
      >
        <span class="flex items-center">
          <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Routing Rules
        </span>
      </button>
      <button
        @click="activePluginTab = 'configuration'"
        :class="activePluginTab === 'configuration' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 hover:border-gray-300'"
        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
      >
        <span class="flex items-center">
          <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Configuration
        </span>
      </button>
      <button
        @click="activePluginTab = 'registry'"
        :class="activePluginTab === 'registry' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-gray-500 dark:text-gray-400 hover:text-gray-700 hover:border-gray-300'"
        class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors"
      >
        <span class="flex items-center">
          <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
          </svg>
          Registry
          <span class="ml-2 text-xs bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 px-2 py-0.5 rounded">Coming Soon</span>
        </span>
      </button>
    </nav>
  </div>

  <!-- Routing Rules Tab -->
  <div x-show="activePluginTab === 'routing'" x-cloak class="space-y-6">
    <!-- Header with Add Button -->
    <div class="flex justify-between items-center">
      <div>
        <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100">Plugin Routing Rules</h3>
        <p class="text-sm text-gray-600 dark:text-gray-400 mt-1">
          Define rules to control which plugins apply to specific entities based on names, tags, and conditions.
        </p>
      </div>
      <button
        @click="$dispatch('open-rule-modal')"
        class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500"
      >
        <svg class="h-5 w-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
        </svg>
        Add Rule
      </button>
    </div>

    <!-- Routing Rules List -->
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow overflow-hidden">
      <div
        id="routing-rules-list"
        hx-get="{{ root_path }}/admin/plugin-routing/rules"
        hx-trigger="load"
        hx-swap="innerHTML"
      >
        <!-- Loading state -->
        <div class="p-8 text-center">
          <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="mt-2 text-sm text-gray-500 dark:text-gray-400">Loading routing rules...</p>
        </div>
      </div>
    </div>

    <!-- Info Card -->
    <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
      <div class="flex">
        <div class="flex-shrink-0">
          <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
        </div>
        <div class="ml-3 flex-1">
          <h4 class="text-sm font-medium text-blue-800 dark:text-blue-200">About Routing Rules</h4>
          <p class="mt-1 text-sm text-blue-700 dark:text-blue-300">
            Routing rules determine which plugins are applied to which entities (tools, prompts, resources, etc.).
            Rules can match by entity name, tags, or custom conditions. Higher priority plugins execute first (lower numbers = higher priority).
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Configuration Tab (current content) -->
  <div x-show="activePluginTab === 'configuration'" x-cloak class="space-y-6">
  <!-- Plugin Overview Card -->
  <div
    class="bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg shadow-lg p-6 text-white"
  >
    <h2 class="text-2xl font-bold mb-4 flex items-center">
      <svg
        class="h-8 w-8 mr-3"
        xmlns="http://www.w3.org/2000/svg"
        fill="none"
        viewBox="0 0 24 24"
        stroke="currentColor"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"
        />
      </svg>
      Plugin Configuration
    </h2>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="text-center">
        <div class="text-3xl font-bold">{{ stats.total_plugins }}</div>
        <div class="text-purple-100 text-sm">Total Plugins</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold">{{ stats.enabled_plugins }}</div>
        <div class="text-purple-100 text-sm">Enabled</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold">{{ stats.disabled_plugins }}</div>
        <div class="text-purple-100 text-sm">Disabled</div>
      </div>
      <div class="text-center">
        <div class="text-3xl font-bold">
          {{ stats.plugins_by_mode.enforce | default(0) }}
        </div>
        <div class="text-purple-100 text-sm">Enforce Mode</div>
      </div>
    </div>
  </div>

  <!-- Plugin Statistics Cards -->
  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
    <!-- Hooks Distribution -->
    <div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
      <h3 class="text-lg font-medium mb-4 dark:text-gray-200 flex items-center">
        <svg
          class="h-6 w-6 mr-2 text-indigo-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"
          />
        </svg>
        Hook Points
      </h3>
      <div class="space-y-2">
        <div
          class="flex justify-between items-center p-2 bg-indigo-50 rounded dark:bg-indigo-900/20 cursor-pointer hover:bg-indigo-100 dark:hover:bg-indigo-900/30 transition-colors border border-indigo-200 dark:border-indigo-800"
          onclick="filterByHook('')"
        >
          <span
            class="text-sm font-medium text-indigo-700 dark:text-indigo-300"
            >All Hooks</span
          >
          <span
            class="bg-indigo-200 text-indigo-900 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-indigo-800 dark:text-indigo-100"
          >
            {{ stats.total_plugins }}
          </span>
        </div>
        {% for hook, count in stats.plugins_by_hook.items() %}
        <div
          class="flex justify-between items-center p-2 bg-gray-50 rounded dark:bg-gray-700 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600 transition-colors"
          onclick="filterByHook('{{ hook }}')"
        >
          <span class="text-sm font-medium text-gray-700 dark:text-gray-300"
            >{{ hook.replace('_', ' ').title() }}</span
          >
          <span
            class="bg-indigo-100 text-indigo-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-indigo-900 dark:text-indigo-200"
          >
            {{ count }}
          </span>
        </div>
        {% endfor %}
      </div>
    </div>

    <!-- Top Tags -->
    <div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
      <h3 class="text-lg font-medium mb-4 dark:text-gray-200 flex items-center">
        <svg
          class="h-6 w-6 mr-2 text-indigo-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M7 7h.01M7 3h5c.512 0 1.024.195 1.414.586l7 7a2 2 0 010 2.828l-7 7a2 2 0 01-2.828 0l-7-7A1.994 1.994 0 013 12V7a4 4 0 014-4z"
          />
        </svg>
        Popular Tags
      </h3>
      <div class="flex flex-wrap gap-2">
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors border border-indigo-300 dark:border-indigo-700"
          onclick="filterByTag('')"
        >
          All Tags
          <span class="ml-1 text-xs text-indigo-600 dark:text-indigo-300"
            >({{ stats.total_plugins }})</span
          >
        </span>
        {% for tag, count in stats.plugins_by_tag.items() %}
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          onclick="filterByTag('{{ tag }}')"
        >
          {{ tag }}
          <span class="ml-1 text-xs text-gray-500 dark:text-gray-400"
            >({{ count }})</span
          >
        </span>
        {% endfor %}
      </div>
    </div>

    <!-- Authors -->
    <div class="bg-white rounded-lg shadow p-6 dark:bg-gray-800">
      <h3 class="text-lg font-medium mb-4 dark:text-gray-200 flex items-center">
        <svg
          class="h-6 w-6 mr-2 text-indigo-600"
          fill="none"
          stroke="currentColor"
          viewBox="0 0 24 24"
        >
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"
          />
        </svg>
        Authors
      </h3>
      <div class="flex flex-wrap gap-2">
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200 cursor-pointer hover:bg-indigo-200 dark:hover:bg-indigo-800 transition-colors border border-indigo-300 dark:border-indigo-700"
          onclick="filterByAuthor('')"
        >
          All Authors
          <span class="ml-1 text-xs text-indigo-600 dark:text-indigo-300"
            >({{ stats.total_plugins }})</span
          >
        </span>
        {% for author, count in stats.plugins_by_author.items() %}
        <span
          class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-200 cursor-pointer hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
          onclick="filterByAuthor('{{ author }}')"
        >
          {{ author }}
          <span class="ml-1 text-xs text-gray-500 dark:text-gray-400"
            >({{ count }})</span
          >
        </span>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Search and Filter Controls -->
  <div class="bg-white rounded-lg shadow p-4 dark:bg-gray-800">
    <div class="flex flex-col md:flex-row gap-4">
      <div class="flex-1">
        <input
          type="text"
          id="plugin-search"
          placeholder="Search plugins by name, description, or author..."
          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
          oninput="filterPlugins()"
        />
      </div>
      <div class="flex gap-2">
        <select
          id="plugin-mode-filter"
          onchange="filterPlugins()"
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          <option value="">All Modes</option>
          <option value="enforce">Enforce</option>
          <option value="permissive">Permissive</option>
          <option value="disabled">Disabled</option>
        </select>
        <select
          id="plugin-status-filter"
          onchange="filterPlugins()"
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          <option value="">All Status</option>
          <option value="enabled">Enabled</option>
          <option value="disabled">Disabled</option>
        </select>
        <select
          id="plugin-hook-filter"
          onchange="filterPlugins()"
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          <option value="">All Hooks</option>
        </select>
        <select
          id="plugin-tag-filter"
          onchange="filterPlugins()"
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          <option value="">All Tags</option>
        </select>
        <select
          id="plugin-author-filter"
          onchange="filterPlugins()"
          class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:border-gray-600 dark:text-white"
        >
          <option value="">All Authors</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Plugin Grid -->
  <div
    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"
    id="plugin-grid"
  >
    {% for plugin in plugins %}
    <div
      class="plugin-card bg-white rounded-lg shadow-lg p-6 hover:shadow-xl transition-shadow dark:bg-gray-800"
      data-name="{{ plugin.name | lower }}"
      data-description="{{ plugin.description | lower }}"
      data-author="{{ plugin.author | lower }}"
      data-mode="{{ plugin.mode }}"
      data-status="{{ plugin.status }}"
      data-hooks="{{ plugin.hooks | join(',') if plugin.hooks else '' }}"
      data-tags="{{ plugin.tags | join(',') if plugin.tags else '' }}"
    >
      <!-- Plugin Header -->
      <div class="flex justify-between items-start mb-3">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-gray-100">
          {{ plugin.name }}
        </h3>
        <span class="text-xs text-gray-500 dark:text-gray-400"
          >v{{ plugin.version }}</span
        >
      </div>

      <!-- Description -->
      <p class="text-sm text-gray-600 dark:text-gray-300 mb-4 line-clamp-2">
        {{ plugin.description[:100] }}{% if plugin.description|length > 100
        %}...{% endif %}
      </p>

      <!-- Author and Priority -->
      <div class="text-xs text-gray-500 dark:text-gray-400 mb-3">
        <div>Author: {{ plugin.author }}</div>
        <div>Priority: {{ plugin.priority }}</div>
      </div>

      <!-- Status and Mode -->
      <div class="flex items-center gap-2 mb-4 flex-wrap">
        <!-- Status Indicator -->
        <div class="flex items-center">
          {% if plugin.status == 'enabled' %}
          <span class="w-2 h-2 bg-green-500 rounded-full mr-2"></span>
          <span class="text-sm text-green-600 dark:text-green-400"
            >Enabled</span
          >
          {% else %}
          <span class="w-2 h-2 bg-gray-400 rounded-full mr-2"></span>
          <span class="text-sm text-gray-500 dark:text-gray-400">Disabled</span>
          {% endif %}
        </div>

        <!-- Mode Badge -->
        {% if plugin.mode == 'enforce' %}
        <span
          class="px-2 py-1 bg-red-100 text-red-800 text-xs font-medium rounded dark:bg-red-900 dark:text-red-200"
        >
          Enforce
        </span>
        {% elif plugin.mode == 'permissive' %}
        <span
          class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded dark:bg-blue-900 dark:text-blue-200"
        >
          Permissive
        </span>
        {% else %}
        <span
          class="px-2 py-1 bg-gray-100 text-gray-800 text-xs font-medium rounded dark:bg-gray-700 dark:text-gray-300"
        >
          Disabled
        </span>
        {% endif %}

        <!-- Implementation Badge -->
        {% if plugin.implementation == 'Rust' %}
        <span
          class="px-2 py-1 bg-orange-100 text-orange-800 text-xs font-medium rounded dark:bg-orange-900 dark:text-orange-200"
          title="Rust-accelerated implementation (5-100x faster)"
        >
          ü¶Ä Rust
        </span>
        {% elif plugin.implementation == 'Python' %}
        <span
          class="px-2 py-1 bg-blue-100 text-blue-800 text-xs font-medium rounded dark:bg-blue-900 dark:text-blue-200"
          title="Pure Python implementation"
        >
          üêç Python
        </span>
        {% endif %}
      </div>

      <!-- Tags -->
      {% if plugin.tags %}
      <div class="flex flex-wrap gap-1 mb-4">
        {% for tag in plugin.tags[:3] %}
        <span
          class="px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded dark:bg-gray-700 dark:text-gray-300"
        >
          {{ tag }}
        </span>
        {% endfor %} {% if plugin.tags|length > 3 %}
        <span class="px-2 py-1 text-gray-500 text-xs">
          +{{ plugin.tags|length - 3 }} more
        </span>
        {% endif %}
      </div>
      {% endif %}

      <!-- Hooks -->
      {% if plugin.hooks %}
      <div class="text-xs text-gray-500 dark:text-gray-400 mb-4">
        <div class="font-medium mb-1">Hooks:</div>
        <div class="flex flex-wrap gap-1">
          {% for hook in plugin.hooks[:2] %}
          <span class="text-xs">{{ hook.replace('_', ' ') }}</span>
          {% if not loop.last %}<span>,</span>{% endif %} {% endfor %} {% if
          plugin.hooks|length > 2 %}
          <span>... ({{ plugin.hooks|length }} total)</span>
          {% endif %}
        </div>
      </div>
      {% endif %}

      <!-- Action Button -->
      <button
        onclick="showPluginDetails('{{ plugin.name }}')"
        class="w-full mt-4 px-4 py-2 bg-indigo-600 text-white text-sm font-medium rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-colors"
      >
        View Details ‚Üí
      </button>
    </div>
    {% endfor %}
  </div>

  {% if not plugins %}
  <div class="bg-gray-50 rounded-lg p-8 text-center dark:bg-gray-800">
    <svg
      class="mx-auto h-12 w-12 text-gray-400"
      fill="none"
      stroke="currentColor"
      viewBox="0 0 24 24"
    >
      <path
        stroke-linecap="round"
        stroke-linejoin="round"
        stroke-width="2"
        d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"
      />
    </svg>
    <h3 class="mt-2 text-sm font-medium text-gray-900 dark:text-gray-100">
      No plugins found
    </h3>
    <p class="mt-1 text-sm text-gray-500 dark:text-gray-400">
      No plugins are currently loaded in the system.
    </p>
  </div>
  {% endif %} {% endif %}
</div>

<!-- Plugin Details Modal (hidden by default) -->
<div
  id="plugin-details-modal"
  class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
>
  <div
    class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white dark:bg-gray-800"
  >
    <div class="mt-3">
      <div class="flex justify-between items-start mb-4">
        <h3
          class="text-lg font-medium text-gray-900 dark:text-gray-100"
          id="modal-plugin-name"
        >
          Plugin Details
        </h3>
        <button
          onclick="closePluginDetails()"
          class="text-gray-400 hover:text-gray-500"
        >
          <svg
            class="h-6 w-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            />
          </svg>
        </button>
      </div>
      <div
        id="modal-plugin-content"
        class="mt-2 text-sm text-gray-500 dark:text-gray-400"
      >
        <!-- Content will be loaded here -->
      </div>
    </div>
  </div>
  </div>
  <!-- End Configuration Tab -->

  <!-- Registry Tab -->
  <div x-show="activePluginTab === 'registry'" x-cloak class="space-y-6">
    <div class="bg-white dark:bg-gray-800 rounded-lg shadow p-6">
      <h3 class="text-lg font-medium text-gray-900 dark:text-gray-100 mb-4">Plugin Registry</h3>
      <p class="text-sm text-gray-600 dark:text-gray-400 mb-6">
        Discover and install plugins from the community registry.
      </p>

      <!-- Placeholder for future feature -->
      <div class="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-8 text-center">
        <svg class="mx-auto h-16 w-16 text-yellow-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <h4 class="text-xl font-medium text-yellow-900 dark:text-yellow-100 mb-3">Coming Soon</h4>
        <p class="text-sm text-yellow-700 dark:text-yellow-300 mb-4">
          The Plugin Registry will allow you to browse, search, and install plugins from manifest files.<br/>
          This feature is planned for a future release.
        </p>
        <div class="inline-flex items-center text-xs text-yellow-600 dark:text-yellow-400 bg-yellow-100 dark:bg-yellow-900/40 px-3 py-1 rounded-full">
          <svg class="h-4 w-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
          </svg>
          Future Feature
        </div>
      </div>
    </div>
  </div>
  <!-- End Registry Tab -->

  <!-- Routing Rule Modal -->
  <div
    x-data="{
      showModal: false,
      ruleIndex: null,
      ruleName: '',
      entities: [],
      nameFilter: '',
      availableEntities: {},
      selectedEntityNames: [],
      availableTags: [],
      tags: [],
      newTag: '',
      hooks: [],
      whenExpression: '',
      reverseOrderOnPost: false,
      selectedPlugins: [],
      init() {
        window.addEventListener('open-rule-modal', (e) => {
          this.showModal = true;
          if (e.detail && e.detail.ruleIndex !== undefined) {
            this.loadRule(e.detail.ruleIndex);
          } else {
            this.resetForm();
          }
        });
        // Watch for changes to entity types and fetch available entities
        this.$watch('entities', (newEntities) => {
          if (newEntities.length > 0) {
            this.fetchEntities();
          } else {
            this.availableEntities = {};
            this.selectedEntityNames = [];
          }
        });
        // Fetch available tags for autocomplete
        this.fetchTags();
      },
      resetForm() {
        this.ruleIndex = null;
        this.ruleName = '';
        this.entities = [];
        this.nameFilter = '';
        this.availableEntities = {};
        this.selectedEntityNames = [];
        this.tags = [];
        this.newTag = '';
        this.hooks = [];
        this.whenExpression = '';
        this.reverseOrderOnPost = false;
        this.selectedPlugins = [];
      },
      async fetchEntities() {
        if (this.entities.length === 0) {
          this.availableEntities = {};
          return;
        }

        try {
          const entityTypes = this.entities.join(',');
          const response = await fetch(`{{ root_path }}/admin/plugin-routing/entities?entity_types=${entityTypes}`);
          if (!response.ok) {
            throw new Error(`Failed to fetch entities: ${response.statusText}`);
          }
          this.availableEntities = await response.json();
          console.log('Fetched entities:', this.availableEntities);
        } catch (error) {
          console.error('Failed to fetch entities:', error);
          this.availableEntities = {};
        }
      },
      async loadRule(index) {
        try {
          this.ruleIndex = index;
          const response = await fetch(`{{ root_path }}/admin/plugin-routing/rules/${index}`);
          if (!response.ok) {
            throw new Error(`Failed to load rule: ${response.statusText}`);
          }
          const ruleData = await response.json();
          console.log('Loaded rule data:', ruleData);
          console.log('Number of plugins:', ruleData.plugins ? ruleData.plugins.length : 0);

          // Populate form fields
          this.ruleName = ruleData.display_name || '';
          this.nameFilter = ruleData.name_filter || '';
          this.entities = ruleData.entities || [];

          // Parse name_filter into selectedEntityNames if it exists
          if (this.nameFilter) {
            this.selectedEntityNames = this.nameFilter.split(',').map(s => s.trim()).filter(s => s);
          } else {
            this.selectedEntityNames = [];
          }

          this.tags = ruleData.tags || [];
          this.hooks = ruleData.hooks || [];
          this.whenExpression = ruleData.when || '';
          this.reverseOrderOnPost = ruleData.reverse_order_on_post || false;
          this.selectedPlugins = ruleData.plugins || [];
          console.log('selectedPlugins after assignment:', this.selectedPlugins.length);

          // Fetch available entities after loading entity types
          if (this.entities.length > 0) {
            await this.fetchEntities();
          }
        } catch (error) {
          console.error('Failed to load rule:', error);
          alert('Failed to load rule: ' + error.message);
          this.resetForm();
        }
      },
      toggleEntityName(entityName) {
        const index = this.selectedEntityNames.indexOf(entityName);
        if (index > -1) {
          this.selectedEntityNames.splice(index, 1);
        } else {
          this.selectedEntityNames.push(entityName);
        }
        // Update nameFilter to reflect selected entities
        this.nameFilter = this.selectedEntityNames.join(',');
      },
      getEntityTypeLabel(entityType) {
        const labels = {
          'tool': 'Tools',
          'prompt': 'Prompts',
          'resource': 'Resources',
          'agent': 'Agents',
          'virtual_server': 'Virtual Servers',
          'mcp_server': 'MCP Servers'
        };
        return labels[entityType] || entityType;
      },
      async fetchTags() {
        try {
          const response = await fetch(`{{ root_path }}/admin/plugin-routing/tags`);
          if (!response.ok) {
            throw new Error(`Failed to fetch tags: ${response.statusText}`);
          }
          this.availableTags = await response.json();
          console.log('Fetched tags:', this.availableTags);

          // Manually populate datalist since Alpine x-for doesn't work well with datalist
          const datalist = document.getElementById('tag-suggestions');
          if (datalist) {
            datalist.innerHTML = '';
            this.availableTags.forEach(tag => {
              const option = document.createElement('option');
              option.value = tag;
              datalist.appendChild(option);
            });
          }
        } catch (error) {
          console.error('Failed to fetch tags:', error);
          this.availableTags = [];
        }
      },
      addTag() {
        if (this.newTag && !this.tags.includes(this.newTag)) {
          this.tags.push(this.newTag);
          this.newTag = '';
        }
      },
      removeTag(tag) {
        this.tags = this.tags.filter(t => t !== tag);
      },
      addPlugin() {
        // Calculate next priority: max(existing) + 10, or 10 if none
        const maxPriority = this.selectedPlugins.length > 0
          ? Math.max(...this.selectedPlugins.map(p => p.priority || 0))
          : 0;
        const nextPriority = maxPriority > 0 ? maxPriority + 10 : 10;
        this.selectedPlugins.push({ name: '', priority: nextPriority });
      },
      removePlugin(index) {
        this.selectedPlugins.splice(index, 1);
      },
      async saveRule() {
        const formData = new FormData();
        if (this.ruleIndex !== null) {
          formData.append('rule_index', this.ruleIndex);
        }
        formData.append('rule_name', this.ruleName);

        // Add entities
        this.entities.forEach(entity => formData.append('entities', entity));

        // Add name filter
        if (this.nameFilter) {
          formData.append('name_filter', this.nameFilter);
        }

        // Add tags
        this.tags.forEach(tag => formData.append('tags', tag));

        // Add hooks
        this.hooks.forEach(hook => formData.append('hooks', hook));

        // Add when expression
        if (this.whenExpression) {
          formData.append('when_expression', this.whenExpression);
        }

        // Add reverse order flag
        formData.append('reverse_order_on_post', this.reverseOrderOnPost);

        // Add plugins
        formData.append('plugins', JSON.stringify(this.selectedPlugins));

        try {
          const url = this.ruleIndex !== null
            ? '{{ root_path }}/admin/plugin-routing/rules/' + this.ruleIndex
            : '{{ root_path }}/admin/plugin-routing/rules';

          const response = await fetch(url, {
            method: 'POST',
            body: formData
          });

          if (response.ok) {
            console.log('Rule saved successfully, triggering refresh');
            this.showModal = false;
            // Directly reload the routing rules list using htmx.ajax
            setTimeout(() => {
              const listElement = document.getElementById('routing-rules-list');
              if (listElement) {
                const url = listElement.getAttribute('hx-get');
                console.log('Reloading routing rules from:', url);
                htmx.ajax('GET', url, {
                  target: '#routing-rules-list',
                  swap: 'innerHTML'
                });
              }
            }, 100);
          } else {
            const error = await response.text();
            alert('Failed to save rule: ' + error);
          }
        } catch (e) {
          console.error('Failed to save rule:', e);
          alert('Failed to save rule: ' + e.message);
        }
      }
    }"
    x-cloak
  >
    <!-- Modal Overlay -->
    <div
      x-show="showModal"
      x-transition:enter="transition ease-out duration-300"
      x-transition:enter-start="opacity-0"
      x-transition:enter-end="opacity-100"
      x-transition:leave="transition ease-in duration-200"
      x-transition:leave-start="opacity-100"
      x-transition:leave-end="opacity-0"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50"
      @click.self="showModal = false"
    >
      <!-- Modal Content -->
      <div
        class="relative top-10 mx-auto p-6 border w-11/12 max-w-4xl shadow-lg rounded-lg bg-white dark:bg-gray-800 mb-10"
        @click.stop
      >
        <!-- Modal Header -->
        <div class="flex justify-between items-center mb-6">
          <h3 class="text-xl font-semibold text-gray-900 dark:text-gray-100">
            <span x-text="ruleIndex !== null ? 'Edit Routing Rule' : 'Create Routing Rule'"></span>
          </h3>
          <button
            @click="showModal = false"
            class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300"
          >
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>

        <!-- Modal Body -->
        <div class="space-y-6">
          <!-- Rule Name -->
          <div>
            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Rule Name <span class="text-red-500">*</span>
            </label>
            <input
              type="text"
              x-model="ruleName"
              placeholder="e.g., pii-filter-customer-tools"
              class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
              required
            />
            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">A unique identifier for this rule</p>
          </div>

          <!-- Plugins Section -->
          <div>
            <div class="flex justify-between items-center mb-2">
              <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">
                Plugins <span class="text-red-500">*</span>
              </label>
              <button
                @click="addPlugin()"
                type="button"
                class="inline-flex items-center px-3 py-1 text-sm bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors"
              >
                <svg class="h-4 w-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Plugin
              </button>
            </div>
            <div class="space-y-2">
              <template x-for="(plugin, index) in selectedPlugins" :key="index">
                <div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-md border border-gray-200 dark:border-gray-600"
                     x-data="{ showAdvanced: false }">
                  <!-- Plugin name, priority, and controls -->
                  <div class="flex gap-2 items-center">
                    <div class="flex-1">
                      <select
                        x-model="plugin.name"
                        class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                        required
                      >
                        <option value="">Select plugin...</option>
                        {% for available_plugin in available_plugins %}
                        <option value="{{ available_plugin.name }}">{{ available_plugin.name }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="w-24">
                      <input
                        type="number"
                        x-model="plugin.priority"
                        placeholder="Priority"
                        min="0"
                        max="1000"
                        class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                      />
                    </div>
                    <button
                      @click="showAdvanced = !showAdvanced"
                      type="button"
                      class="px-2 py-2 text-indigo-600 hover:text-indigo-800 dark:text-indigo-400 dark:hover:text-indigo-300"
                      title="Advanced options"
                    >
                      <svg class="h-5 w-5 transition-transform" :class="{ 'rotate-90': showAdvanced }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                      </svg>
                    </button>
                    <button
                      @click="removePlugin(index)"
                      type="button"
                      class="px-2 py-2 text-red-600 hover:text-red-800 dark:text-red-400 dark:hover:text-red-300"
                      title="Remove plugin"
                    >
                      <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                      </svg>
                    </button>
                  </div>

                  <!-- Advanced Configuration (expandable) -->
                  <div x-show="showAdvanced" x-collapse class="mt-3 space-y-2 pt-3 border-t border-gray-300 dark:border-gray-600">
                    <!-- Config JSON -->
                    <div>
                      <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Config (JSON)</label>
                      <textarea
                        x-model="plugin.config"
                        rows="2"
                        placeholder='{"key": "value"}'
                        class="w-full px-2 py-1 text-xs font-mono border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                      ></textarea>
                    </div>

                    <div class="grid grid-cols-2 gap-2">
                      <!-- Override -->
                      <div class="flex items-center space-x-2">
                        <input
                          type="checkbox"
                          x-model="plugin.override"
                          class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-700"
                        />
                        <label class="text-xs text-gray-600 dark:text-gray-400">
                          Override
                          <span class="block text-gray-500">Replace config</span>
                        </label>
                      </div>

                      <!-- Mode -->
                      <div>
                        <label class="block text-xs text-gray-600 dark:text-gray-400 mb-1">Mode</label>
                        <select
                          x-model="plugin.mode"
                          class="w-full px-2 py-1 text-xs border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                        >
                          <option value="">Default</option>
                          <option value="enforce">Enforce</option>
                          <option value="enforce_ignore_error">Enforce (ignore error)</option>
                          <option value="permissive">Permissive</option>
                          <option value="disabled">Disabled</option>
                        </select>
                      </div>
                    </div>
                  </div>
                </div>
              </template>
              <div x-show="selectedPlugins.length === 0" class="text-sm text-gray-500 dark:text-gray-400 italic text-center p-4">
                No plugins added yet. Click "Add Plugin" to add one.
              </div>
            </div>

            <!-- Reverse Order on Post -->
            <div class="mt-3">
              <label class="inline-flex items-center">
                <input
                  type="checkbox"
                  x-model="reverseOrderOnPost"
                  class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                />
                <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">Reverse plugin order for post-hooks (LIFO wrapping)</span>
              </label>
            </div>
          </div>

          <!-- Collapsible Filter Sections -->
          <div class="border-t border-gray-200 dark:border-gray-700 pt-4">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-3">Filtering Options</h4>

            <!-- Filter on Entity Type -->
            <div class="mb-3" x-data="{ expanded: false }">
              <button
                @click="expanded = !expanded"
                type="button"
                class="w-full flex items-center justify-between px-4 py-2 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
              >
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  üéØ Filter on Entity Type
                  <span x-show="entities.length > 0 || selectedEntityNames.length > 0" class="ml-2 text-xs text-indigo-600 dark:text-indigo-400">
                    (<span x-text="entities.length > 0 ? entities.length + ' types' : ''"></span><span x-show="entities.length > 0 && selectedEntityNames.length > 0">, </span><span x-text="selectedEntityNames.length > 0 ? selectedEntityNames.length + ' entities' : ''"></span>)
                  </span>
                </span>
                <svg class="h-5 w-5 transition-transform text-gray-500" :class="{ 'rotate-180': expanded }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div x-show="expanded" x-collapse class="mt-2 px-4 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md">
                <!-- Entity Types -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Entity Types
                  </label>
                  <div class="flex flex-wrap gap-2">
                    <template x-for="entityType in [
                      {value: 'tool', label: 'Tool'},
                      {value: 'prompt', label: 'Prompt'},
                      {value: 'resource', label: 'Resource'},
                      {value: 'agent', label: 'Agent'},
                      {value: 'virtual_server', label: 'Virtual Server'},
                      {value: 'mcp_server', label: 'MCP Server'}
                    ]" :key="entityType.value">
                      <label class="inline-flex items-center">
                        <input
                          type="checkbox"
                          :value="entityType.value"
                          x-model="entities"
                          class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                        />
                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300" x-text="entityType.label"></span>
                      </label>
                    </template>
                  </div>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Leave empty for HTTP-level hooks</p>
                </div>

                <!-- Specific Entities Selection -->
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Specific Entities
                  </label>

                  <!-- Show entity selection when entity types are selected -->
                  <div x-show="entities.length > 0 && Object.keys(availableEntities).length > 0">
                    <div class="border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 max-h-64 overflow-y-auto">
                      <template x-for="(entityList, entityType) in availableEntities" :key="entityType">
                        <div class="border-b border-gray-200 dark:border-gray-600 last:border-0">
                          <div class="px-3 py-2 bg-gray-50 dark:bg-gray-800">
                            <span class="text-xs font-semibold text-gray-700 dark:text-gray-300 uppercase" x-text="getEntityTypeLabel(entityType)"></span>
                            <span class="text-xs text-gray-500 dark:text-gray-400 ml-2" x-text="'(' + entityList.length + ')'"></span>
                          </div>
                          <template x-for="entity in entityList" :key="entity.id">
                            <label class="flex items-center px-4 py-2 hover:bg-gray-50 dark:hover:bg-gray-700/50 cursor-pointer">
                              <input
                                type="checkbox"
                                :value="entity.name"
                                :checked="selectedEntityNames.includes(entity.name)"
                                @change="toggleEntityName(entity.name)"
                                class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                              />
                              <span class="ml-2 text-sm text-gray-700 dark:text-gray-300" x-text="entity.display_name"></span>
                              <span class="ml-2 text-xs text-gray-400" x-text="'(' + entity.name + ')'"></span>
                            </label>
                          </template>
                        </div>
                      </template>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                      Select specific entities to filter, or leave empty to match all entities of the selected types
                    </p>
                  </div>

                  <!-- Show message when entity types are selected but no entities found -->
                  <div x-show="entities.length > 0 && Object.keys(availableEntities).length === 0" class="text-sm text-gray-500 dark:text-gray-400 italic">
                    Loading available entities...
                  </div>

                  <!-- Show manual input when no entity types are selected -->
                  <div x-show="entities.length === 0">
                    <input
                      type="text"
                      x-model="nameFilter"
                      placeholder="e.g., create_user or create_user,update_user,delete_user"
                      class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                    />
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                      Select entity types above to see available entities, or enter names manually (comma-separated)
                    </p>
                  </div>

                  <!-- Show selected entities as chips -->
                  <div class="flex flex-wrap gap-2 mt-2" x-show="selectedEntityNames.length > 0">
                    <template x-for="entityName in selectedEntityNames" :key="entityName">
                      <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                        <span x-text="entityName"></span>
                        <button @click="toggleEntityName(entityName)" class="ml-2 text-indigo-600 dark:text-indigo-300 hover:text-indigo-800">&times;</button>
                      </span>
                    </template>
                  </div>
                </div>
              </div>
            </div>

            <!-- Filter on Tags -->
            <div class="mb-3" x-data="{ expanded: false }">
              <button
                @click="expanded = !expanded"
                type="button"
                class="w-full flex items-center justify-between px-4 py-2 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
              >
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  üè∑Ô∏è Filter on Tags
                  <span x-show="tags.length > 0" class="ml-2 text-xs text-indigo-600 dark:text-indigo-400">
                    (<span x-text="tags.length"></span>)
                  </span>
                </span>
                <svg class="h-5 w-5 transition-transform text-gray-500" :class="{ 'rotate-180': expanded }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div x-show="expanded" x-collapse class="mt-2 px-4 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md">
                <div class="flex gap-2 mb-2">
                  <input
                    type="text"
                    x-model="newTag"
                    @keydown.enter.prevent="addTag()"
                    list="tag-suggestions"
                    placeholder="Add tag..."
                    class="flex-1 px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"
                  />
                  <datalist id="tag-suggestions">
                    <!-- Options populated by fetchTags() function -->
                  </datalist>
                  <button
                    @click="addTag()"
                    type="button"
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors"
                  >
                    Add
                  </button>
                </div>
                <div class="flex flex-wrap gap-2" x-show="tags.length > 0">
                  <template x-for="(tag, index) in tags" :key="index">
                    <span class="inline-flex items-center px-3 py-1 rounded-full text-sm bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                      <span x-text="tag"></span>
                      <button @click="removeTag(tag)" class="ml-2 text-green-600 dark:text-green-300 hover:text-green-800">&times;</button>
                    </span>
                  </template>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Tag-based matching for flexible filtering</p>
              </div>
            </div>

            <!-- Filter on Hook Types -->
            <div class="mb-3" x-data="{ expanded: false }">
              <button
                @click="expanded = !expanded"
                type="button"
                class="w-full flex items-center justify-between px-4 py-2 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
              >
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  ü™ù Filter on Hook Types
                  <span x-show="hooks.length > 0" class="ml-2 text-xs text-indigo-600 dark:text-indigo-400">
                    (<span x-text="hooks.length"></span>)
                  </span>
                </span>
                <svg class="h-5 w-5 transition-transform text-gray-500" :class="{ 'rotate-180': expanded }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div x-show="expanded" x-collapse class="mt-2 px-4 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md">
                <div class="grid grid-cols-2 gap-2">
                  <template x-for="hookType in ['tool_pre_invoke', 'tool_post_invoke', 'prompt_pre_invoke', 'prompt_post_invoke', 'resource_pre_invoke', 'resource_post_invoke', 'http_pre_request', 'http_post_response']" :key="hookType">
                    <label class="inline-flex items-center">
                      <input
                        type="checkbox"
                        :value="hookType"
                        x-model="hooks"
                        class="rounded border-gray-300 text-indigo-600 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"
                      />
                      <span class="ml-2 text-xs text-gray-700 dark:text-gray-300" x-text="hookType.replace(/_/g, ' ')"></span>
                    </label>
                  </template>
                </div>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Leave empty to apply to all hooks</p>
              </div>
            </div>

            <!-- Conditional Expressions -->
            <div class="mb-3" x-data="{ expanded: false }">
              <button
                @click="expanded = !expanded"
                type="button"
                class="w-full flex items-center justify-between px-4 py-2 bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 rounded-md transition-colors"
              >
                <span class="text-sm font-medium text-gray-700 dark:text-gray-300">
                  ‚ö° Filter on Conditional Expressions
                  <span x-show="whenExpression && whenExpression.trim()" class="ml-2 text-xs text-indigo-600 dark:text-indigo-400">
                    (active)
                  </span>
                </span>
                <svg class="h-5 w-5 transition-transform text-gray-500" :class="{ 'rotate-180': expanded }" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
              </button>
              <div x-show="expanded" x-collapse class="mt-2 px-4 py-3 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-600 rounded-md">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  When Expression
                </label>
                <textarea
                  x-model="whenExpression"
                  rows="3"
                  placeholder="e.g., payload.uri.endswith('.env') or payload.method == 'POST'"
                  class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500 font-mono text-sm"
                ></textarea>
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Python expression for complex matching logic</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Modal Footer -->
        <div class="flex justify-end gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
          <button
            @click="showModal = false"
            type="button"
            class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
          >
            Cancel
          </button>
          <button
            @click="saveRule()"
            type="button"
            class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-md transition-colors"
            :disabled="!ruleName || selectedPlugins.length === 0"
            :class="{ 'opacity-50 cursor-not-allowed': !ruleName || selectedPlugins.length === 0 }"
          >
            <span x-text="ruleIndex !== null ? 'Update Rule' : 'Create Rule'"></span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- End Routing Rule Modal -->

</div>
