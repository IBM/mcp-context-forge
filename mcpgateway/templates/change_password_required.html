<!doctype html>
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Password Change Required - MCP Gateway</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: "class",
        theme: {
          extend: {
            animation: {
              "gradient-x": "gradient-x 15s ease infinite",
              float: "float 6s ease-in-out infinite",
              "pulse-soft": "pulse-soft 2s ease-in-out infinite",
              "slide-up": "slide-up 0.8s ease-out",
              "fade-in": "fade-in 1s ease-out",
              "scale-pulse": "scale-pulse 4s ease-in-out infinite",
            },
            keyframes: {
              "gradient-x": {
                "0%, 100%": {
                  "background-size": "200% 200%",
                  "background-position": "left center",
                },
                "50%": {
                  "background-size": "200% 200%",
                  "background-position": "right center",
                },
              },
              float: {
                "0%, 100%": { transform: "translateY(0px)" },
                "50%": { transform: "translateY(-20px)" },
              },
              "pulse-soft": {
                "0%, 100%": { opacity: 1 },
                "50%": { opacity: 0.8 },
              },
              "slide-up": {
                "0%": { transform: "translateY(30px)", opacity: 0 },
                "100%": { transform: "translateY(0)", opacity: 1 },
              },
              "fade-in": {
                "0%": { opacity: 0 },
                "100%": { opacity: 1 },
              },
              "scale-pulse": {
                "0%, 100%": { transform: "scale(1)" },
                "50%": { transform: "scale(1.05)" },
              },
            },
          },
        },
      };
    </script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
  </head>
  <body class="h-full bg-gray-50 dark:bg-gray-900">
    <!-- Main Split Layout -->
    <div class="min-h-screen flex">
      <!-- Left Side - Password Change Form -->
      <div
        class="flex-1 flex flex-col justify-center py-6 px-4 sm:px-6 lg:px-8 bg-white dark:bg-gray-900 relative overflow-hidden"
      >
        <!-- Subtle background decoration -->
        <div
          class="absolute inset-0 bg-gradient-to-br from-blue-50/50 to-indigo-100/30 dark:from-gray-800/50 dark:to-gray-700/30"
        ></div>
        <div
          class="absolute top-10 left-10 w-32 h-32 bg-gradient-to-br from-indigo-200/30 to-purple-200/30 dark:from-indigo-800/30 dark:to-purple-800/30 rounded-full animate-float"
        ></div>
        <div
          class="absolute bottom-20 right-10 w-24 h-24 bg-gradient-to-br from-purple-200/30 to-blue-200/30 dark:from-purple-800/30 dark:to-blue-800/30 rounded-full animate-float"
          style="animation-delay: 2s"
        ></div>

        <div class="sm:mx-auto sm:w-full sm:max-w-md relative z-10">
          <!-- Password Change Card -->
          <div
            class="bg-white/90 dark:bg-gray-800/90 backdrop-blur-xl py-8 px-6 shadow-2xl rounded-2xl border border-gray-200/50 dark:border-gray-700/50 animate-slide-up"
            style="animation-delay: 0.2s"
          >
            <!-- Header with key icon -->
            <div class="text-center mb-6">
              <div
                class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-br from-orange-500 to-red-600 rounded-full shadow-lg mb-4 animate-scale-pulse"
              >
                <i class="fas fa-key text-white text-xl"></i>
              </div>
              <h2 class="text-2xl font-bold text-gray-900 dark:text-white">
                Password Change Required
              </h2>
              <p class="text-sm text-gray-600 dark:text-gray-400 mt-2">
                Your password has expired and must be changed to continue.
              </p>
            </div>

            <!-- Grace period warning if applicable -->
            {% if grace_period_remaining %}
            <div class="mb-6 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 text-amber-700 dark:text-amber-400 rounded-xl text-sm">
              <div class="flex items-start">
                <i class="fas fa-exclamation-triangle mr-2 mt-0.5 flex-shrink-0"></i>
                <div>
                  <div class="font-medium">Grace period active</div>
                  <div>You have {{ grace_period_remaining }} days remaining.</div>
                </div>
              </div>
            </div>
            {% endif %}

            <!-- Error messages -->
            <div
              id="error-message"
              class="mb-6 p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 text-red-700 dark:text-red-400 rounded-xl text-sm hidden"
            >
              <div class="flex items-center">
                <i class="fas fa-exclamation-circle mr-2"></i>
                <span id="error-text"></span>
              </div>
            </div>

            <!-- Success messages -->
            <div
              id="success-message"
              class="mb-6 p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 text-green-700 dark:text-green-400 rounded-xl text-sm hidden"
            >
              <div class="flex items-center">
                <i class="fas fa-check-circle mr-2"></i>
                <span id="success-text"></span>
              </div>
            </div>

            <!-- Password Change Form -->
            <form
              id="password-change-form"
              class="space-y-6"
              action="{{ root_path }}/admin/change-password-required"
              method="post"
            >
              <div>
                <label
                  for="current_password"
                  class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                >
                  <i class="fas fa-lock mr-2 text-gray-400"></i>Current Password
                </label>
                <div class="relative">
                  <input
                    id="current_password"
                    name="current_password"
                    type="password"
                    autocomplete="current-password"
                    required
                    placeholder="Enter your current password"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700/50 dark:text-white transition-all duration-200 backdrop-blur-sm pr-10"
                  />
                  <button
                    type="button"
                    onclick="togglePassword('current_password', 'current_password_icon')"
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    <i id="current_password_icon" class="fas fa-eye"></i>
                  </button>
                </div>
              </div>

              <div>
                <label
                  for="new_password"
                  class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                >
                  <i class="fas fa-key mr-2 text-gray-400"></i>New Password
                </label>
                <div class="relative">
                  <input
                    id="new_password"
                    name="new_password"
                    type="password"
                    autocomplete="new-password"
                    required
                    placeholder="Enter your new password"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700/50 dark:text-white transition-all duration-200 backdrop-blur-sm pr-10"
                    onkeyup="validatePassword(this.value)"
                  />
                  <button
                    type="button"
                    onclick="togglePassword('new_password', 'new_password_icon')"
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    <i id="new_password_icon" class="fas fa-eye"></i>
                  </button>
                </div>
                <div class="mt-2 text-sm text-gray-500 dark:text-gray-400" id="password-strength">
                  Password strength: <span id="strength-indicator">Not entered</span>
                </div>
              </div>

              <div>
                <label
                  for="confirm_password"
                  class="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2"
                >
                  <i class="fas fa-check-circle mr-2 text-gray-400"></i>Confirm New Password
                </label>
                <div class="relative">
                  <input
                    id="confirm_password"
                    name="confirm_password"
                    type="password"
                    autocomplete="new-password"
                    required
                    placeholder="Confirm your new password"
                    class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent dark:bg-gray-700/50 dark:text-white transition-all duration-200 backdrop-blur-sm pr-10"
                    onkeyup="validatePasswordMatch()"
                  />
                  <button
                    type="button"
                    onclick="togglePassword('confirm_password', 'confirm_password_icon')"
                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"
                  >
                    <i id="confirm_password_icon" class="fas fa-eye"></i>
                  </button>
                </div>
                <div class="mt-2 text-sm" id="password-match-indicator"></div>
              </div>

              <!-- Password Requirements -->
              <div class="bg-blue-50 dark:bg-blue-900/20 rounded-xl p-4">
                <h4 class="text-sm font-semibold text-blue-800 dark:text-blue-200 mb-2">
                  <i class="fas fa-info-circle mr-1"></i>Password Requirements
                </h4>
                <ul class="space-y-1 text-sm text-blue-700 dark:text-blue-300">
                  <li class="flex items-center" id="req-length">
                    <i class="fas fa-circle text-gray-400 mr-2 text-xs" id="req-length-icon"></i>
                    At least 8 characters long
                  </li>
                  <li class="flex items-center" id="req-uppercase">
                    <i class="fas fa-circle text-gray-400 mr-2 text-xs" id="req-uppercase-icon"></i>
                    Contains uppercase letters (A-Z)
                  </li>
                  <li class="flex items-center" id="req-lowercase">
                    <i class="fas fa-circle text-gray-400 mr-2 text-xs" id="req-lowercase-icon"></i>
                    Contains lowercase letters (a-z)
                  </li>
                  <li class="flex items-center" id="req-special">
                    <i class="fas fa-circle text-gray-400 mr-2 text-xs" id="req-special-icon"></i>
                    Contains special characters (!@#$%^&*)
                  </li>
                </ul>
              </div>

              <button
                type="submit"
                id="submit-btn"
                class="w-full flex justify-center items-center py-2 px-4 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none"
                disabled
              >
                <i class="fas fa-key mr-2"></i>
                Change Password
              </button>
            </form>

            <!-- Footer -->
            <div class="mt-6 text-center">
              <p class="text-xs text-gray-500 dark:text-gray-400">
                <i class="fas fa-shield-alt mr-1"></i>
                Your password will be securely encrypted and stored
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Side - Feature Showcase -->
      <div
        class="flex-1 bg-gradient-to-br from-indigo-600 via-purple-600 to-blue-700 dark:from-indigo-900 dark:via-purple-900 dark:to-blue-900 relative overflow-hidden flex items-center justify-center"
      >
        <!-- Background pattern -->
        <div class="absolute inset-0 opacity-10">
          <div
            class="absolute inset-0"
            style="
              background-image: url('data:image/svg+xml,%3Csvg width=&quot;40&quot; height=&quot;40&quot; viewBox=&quot;0 0 40 40&quot; xmlns=&quot;http://www.w3.org/2000/svg&quot;%3E%3Cg fill=&quot;%23ffffff&quot; fill-opacity=&quot;0.1&quot;%3E%3Cpath d=&quot;M20 20c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10zm10 0c0-5.5-4.5-10-10-10s-10 4.5-10 10 4.5 10 10 10 10-4.5 10-10z&quot;/%3E%3C/g%3E%3C/svg%3E');
            "
          ></div>
        </div>

        <!-- Main content container -->
        <div class="relative z-10 max-w-2xl px-6 py-4">
          <!-- Compact Hero -->
          <div class="text-center mb-6">
            <div class="flex items-center justify-center mb-4">
              <div
                class="inline-flex items-center justify-center w-12 h-12 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-xl shadow-lg mr-3 animate-scale-pulse"
              >
                <img
                  src="{{ root_path }}/static/logo.png"
                  alt="MCP Gateway"
                  class="w-6 h-6 rounded-lg"
                  onerror="this.style.display='none'; this.nextElementSibling.style.display='inline';"
                />
                <i
                  class="fas fa-network-wired text-white text-sm"
                  style="display: none"
                ></i>
              </div>
              <h2 class="text-2xl font-bold text-white">
                Context Forge MCP & AI Gateway
              </h2>
            </div>
            <p class="text-sm text-blue-100 opacity-90">
              MCP, A2A and REST gateway with advanced security & observability
            </p>
          </div>

          <!-- Security Features -->
          <div class="space-y-4">
            <h3
              class="text-sm font-semibold text-blue-200 uppercase tracking-wide mb-4 text-center"
            >
              Security Features
            </h3>
            <div class="grid grid-cols-1 gap-4">
              <div
                class="bg-white/8 backdrop-blur-sm rounded-lg p-4 border border-white/10 hover:bg-white/12 transition-all duration-300"
              >
                <div class="flex items-start">
                  <div
                    class="w-8 h-8 bg-gradient-to-br from-green-400 to-emerald-500 rounded-lg flex items-center justify-center mr-3 flex-shrink-0"
                  >
                    <i class="fas fa-key text-white text-sm"></i>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-white mb-1">
                      Password Security
                    </h4>
                    <p class="text-xs text-blue-100 leading-relaxed">
                      Strong password policies with automatic expiration and complexity requirements
                    </p>
                  </div>
                </div>
              </div>

              <div
                class="bg-white/8 backdrop-blur-sm rounded-lg p-4 border border-white/10 hover:bg-white/12 transition-all duration-300"
              >
                <div class="flex items-start">
                  <div
                    class="w-8 h-8 bg-gradient-to-br from-blue-400 to-indigo-500 rounded-lg flex items-center justify-center mr-3 flex-shrink-0"
                  >
                    <i class="fas fa-shield-alt text-white text-sm"></i>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-white mb-1">
                      Account Protection
                    </h4>
                    <p class="text-xs text-blue-100 leading-relaxed">
                      Multi-factor authentication and account lockout protection
                    </p>
                  </div>
                </div>
              </div>

              <div
                class="bg-white/8 backdrop-blur-sm rounded-lg p-4 border border-white/10 hover:bg-white/12 transition-all duration-300"
              >
                <div class="flex items-start">
                  <div
                    class="w-8 h-8 bg-gradient-to-br from-red-400 to-pink-500 rounded-lg flex items-center justify-center mr-3 flex-shrink-0"
                  >
                    <i class="fas fa-eye text-white text-sm"></i>
                  </div>
                  <div>
                    <h4 class="text-sm font-semibold text-white mb-1">
                      Audit & Monitoring
                    </h4>
                    <p class="text-xs text-blue-100 leading-relaxed">
                      Complete audit trail of all authentication events and activities
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom accent -->
          <div class="mt-6 text-center">
            <div class="inline-flex items-center space-x-4 text-blue-100/80">
              <div class="flex items-center space-x-1">
                <i class="fas fa-lock text-green-300 text-xs"></i>
                <span class="text-xs">Secure by Design</span>
              </div>
              <div class="flex items-center space-x-1">
                <i class="fas fa-check-circle text-blue-300 text-xs"></i>
                <span class="text-xs">Enterprise Ready</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Initialize ROOT_PATH for JavaScript
      window.ROOT_PATH = {{ root_path | tojson }};

      // Password validation state
      let passwordRequirements = {
        length: false,
        uppercase: false,
        lowercase: false,
        special: false
      };

      // Toggle password visibility
      function togglePassword(fieldId, iconId) {
        const field = document.getElementById(fieldId);
        const icon = document.getElementById(iconId);

        if (field.type === "password") {
          field.type = "text";
          icon.classList.remove("fa-eye");
          icon.classList.add("fa-eye-slash");
        } else {
          field.type = "password";
          icon.classList.remove("fa-eye-slash");
          icon.classList.add("fa-eye");
        }
      }

      // Validate password requirements
      function validatePassword(password) {
        // Length check
        passwordRequirements.length = password.length >= 8;
        updateRequirement('length', passwordRequirements.length);

        // Uppercase check
        passwordRequirements.uppercase = /[A-Z]/.test(password);
        updateRequirement('uppercase', passwordRequirements.uppercase);

        // Lowercase check
        passwordRequirements.lowercase = /[a-z]/.test(password);
        updateRequirement('lowercase', passwordRequirements.lowercase);

        // Special characters check
        passwordRequirements.special = /[!@#$%^&*(),.?":{}|<>]/.test(password);
        updateRequirement('special', passwordRequirements.special);

        // Update strength indicator
        updatePasswordStrength();

        // Update submit button state
        updateSubmitButton();

        // Validate password match if confirm password is filled
        if (document.getElementById('confirm_password').value) {
          validatePasswordMatch();
        }
      }

      // Update individual requirement indicator
      function updateRequirement(requirement, met) {
        const icon = document.getElementById(`req-${requirement}-icon`);
        const item = document.getElementById(`req-${requirement}`);

        if (met) {
          icon.classList.remove('fa-circle', 'text-gray-400');
          icon.classList.add('fa-check-circle', 'text-green-500');
          item.classList.add('text-green-600', 'dark:text-green-400');
          item.classList.remove('text-blue-700', 'dark:text-blue-300');
        } else {
          icon.classList.remove('fa-check-circle', 'text-green-500');
          icon.classList.add('fa-circle', 'text-gray-400');
          item.classList.remove('text-green-600', 'dark:text-green-400');
          item.classList.add('text-blue-700', 'dark:text-blue-300');
        }
      }

      // Update password strength indicator
      function updatePasswordStrength() {
        const strengthIndicator = document.getElementById('strength-indicator');
        const password = document.getElementById('new_password').value;

        if (!password) {
          strengthIndicator.textContent = 'Not entered';
          strengthIndicator.className = 'text-gray-500';
          return;
        }

        const metCount = Object.values(passwordRequirements).filter(met => met).length;

        if (metCount <= 2) {
          strengthIndicator.textContent = 'Weak';
          strengthIndicator.className = 'text-red-500';
        } else if (metCount <= 4) {
          strengthIndicator.textContent = 'Medium';
          strengthIndicator.className = 'text-yellow-500';
        } else {
          strengthIndicator.textContent = 'Strong';
          strengthIndicator.className = 'text-green-500';
        }
      }

      // Validate password match
      function validatePasswordMatch() {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const indicator = document.getElementById('password-match-indicator');

        if (!confirmPassword) {
          indicator.textContent = '';
          return;
        }

        if (newPassword === confirmPassword) {
          indicator.innerHTML = '<i class="fas fa-check-circle text-green-500 mr-1"></i><span class="text-green-600 dark:text-green-400">Passwords match</span>';
        } else {
          indicator.innerHTML = '<i class="fas fa-times-circle text-red-500 mr-1"></i><span class="text-red-600 dark:text-red-400">Passwords do not match</span>';
        }

        updateSubmitButton();
      }

      // Update submit button state
      function updateSubmitButton() {
        const newPassword = document.getElementById('new_password').value;
        const confirmPassword = document.getElementById('confirm_password').value;
        const currentPassword = document.getElementById('current_password').value;
        const submitBtn = document.getElementById('submit-btn');

        const allRequirementsMet = Object.values(passwordRequirements).every(met => met);
        const passwordsMatch = newPassword === confirmPassword && newPassword;
        const hasCurrentPassword = currentPassword.trim().length > 0;

        const canSubmit = allRequirementsMet && passwordsMatch && hasCurrentPassword;

        submitBtn.disabled = !canSubmit;
        
        if (canSubmit) {
          submitBtn.classList.remove('opacity-50', 'cursor-not-allowed');
          submitBtn.classList.add('hover:shadow-xl', 'transform', 'hover:-translate-y-0.5');
        } else {
          submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
          submitBtn.classList.remove('hover:shadow-xl', 'transform', 'hover:-translate-y-0.5');
        }
      }

      // Show error message
      function showError(message) {
        const errorDiv = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        const successDiv = document.getElementById('success-message');

        successDiv.classList.add('hidden');
        errorText.textContent = message;
        errorDiv.classList.remove('hidden');

        // Auto-hide after 10 seconds
        setTimeout(() => {
          errorDiv.classList.add('hidden');
        }, 10000);
      }

      // Show success message
      function showSuccess(message) {
        const successDiv = document.getElementById('success-message');
        const successText = document.getElementById('success-text');
        const errorDiv = document.getElementById('error-message');

        errorDiv.classList.add('hidden');
        successText.textContent = message;
        successDiv.classList.remove('hidden');

        // Redirect after showing success message
        setTimeout(() => {
          window.location.href = window.ROOT_PATH + "/admin";
        }, 2000);
      }

      // Handle form submission
      document.getElementById('password-change-form').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const submitBtn = document.getElementById('submit-btn');
        const originalContent = submitBtn.innerHTML;
        
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Changing Password...';
        submitBtn.disabled = true;

        // Get form data
        const formData = new FormData(this);

        // Submit form via fetch
        fetch(this.action, {
          method: 'POST',
          body: formData
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            showSuccess(data.message || 'Password changed successfully! Redirecting to admin panel...');
          } else {
            showError(data.message || 'Failed to change password. Please try again.');
            submitBtn.innerHTML = originalContent;
            submitBtn.disabled = false;
          }
        })
        .catch(error => {
          console.error('Password change error:', error);
          showError('An error occurred while changing your password. Please try again.');
          submitBtn.innerHTML = originalContent;
          submitBtn.disabled = false;
        });
      });

      // Handle error messages from URL parameters
      document.addEventListener('DOMContentLoaded', function() {
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');

        if (error) {
          let errorMessage = 'Password change failed';
          switch (error) {
            case 'invalid_current_password':
              errorMessage = 'Current password is incorrect';
              break;
            case 'password_validation_error':
              errorMessage = 'New password does not meet requirements';
              break;
            case 'passwords_do_not_match':
              errorMessage = 'New passwords do not match';
              break;
            case 'same_password':
              errorMessage = 'New password must be different from current password';
              break;
            case 'server_error':
              errorMessage = 'Server error. Please try again';
              break;
            default:
              errorMessage = error.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
          }
          showError(errorMessage);
        }

        // Initialize validation
        const currentPasswordField = document.getElementById('current_password');
        const newPasswordField = document.getElementById('new_password');
        const confirmPasswordField = document.getElementById('confirm_password');

        currentPasswordField.addEventListener('input', updateSubmitButton);
        newPasswordField.addEventListener('input', function() {
          validatePassword(this.value);
        });
        confirmPasswordField.addEventListener('input', validatePasswordMatch);
      });
    </script>
  </body>
</html>