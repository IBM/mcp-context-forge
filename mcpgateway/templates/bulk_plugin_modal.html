<!-- htmlhint doctype-first:false -->
<!-- Bulk Plugin Configuration Modal -->
<div x-show="$store.toolsPanel.showBulkPluginModal"
     x-cloak
     class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity z-50"
     @click.self="$store.toolsPanel.showBulkPluginModal = false"
     x-data="{
       pluginStatus: null,
       loadingStatus: false,
       selectedForRemoval: [],
       nextPriority: 10,
       async loadPluginStatus() {
         this.loadingStatus = true;
         try {
           const toolIds = window.Alpine.store('toolsPanel').selectedTools.join(',');
           console.log('Loading plugin status for tools:', toolIds);
           const response = await fetch(`{{ root_path }}/admin/tools/bulk/plugins/status?tool_ids=${encodeURIComponent(toolIds)}`, {
             headers: {
               'Accept': 'application/json'
             }
           });
           if (response.ok) {
             const data = await response.json();
             console.log('Plugin status loaded:', data);
             console.log('Plugin status details:', JSON.stringify(data.plugin_status, null, 2));
             this.pluginStatus = data;
             // Update next priority after loading status
             this.nextPriority = this.getNextPriority();
           } else {
             console.error('Failed to load plugin status:', response.status, response.statusText);
           }
         } catch (e) {
           console.error('Failed to load plugin status:', e);
         } finally {
           this.loadingStatus = false;
         }
       },
       async removeSelectedPlugins() {
         if (this.selectedForRemoval.length === 0) return;

         const toolIds = window.Alpine.store('toolsPanel').selectedTools;
         const formData = new FormData();
         toolIds.forEach(id => formData.append('tool_ids', id));
         this.selectedForRemoval.forEach(name => formData.append('plugin_names', name));

         try {
           const response = await fetch(`{{ root_path }}/admin/tools/bulk/plugins`, {
             method: 'DELETE',
             body: formData
           });
           if (response.ok) {
             this.selectedForRemoval = [];
             window.dispatchEvent(new Event('plugin-removed'));
             htmx.trigger('#tools-table', 'refresh');
           }
         } catch (e) {
           console.error('Failed to remove plugins:', e);
         }
       },
       async clearAllPlugins() {
         const toolIds = window.Alpine.store('toolsPanel').selectedTools;
         const formData = new FormData();
         toolIds.forEach(id => formData.append('tool_ids', id));
         formData.append('clear_all', 'true');

         try {
           const response = await fetch(`{{ root_path }}/admin/tools/bulk/plugins`, {
             method: 'DELETE',
             body: formData
           });
           if (response.ok) {
             this.selectedForRemoval = [];
             window.dispatchEvent(new Event('plugin-removed'));
             htmx.trigger('#tools-table', 'refresh');
           }
         } catch (e) {
           console.error('Failed to clear all plugins:', e);
         }
       },
       async updatePluginPriority(pluginName, newPriority) {
         const toolIds = window.Alpine.store('toolsPanel').selectedTools;
         const formData = new FormData();
         toolIds.forEach(id => formData.append('tool_ids', id));
         formData.append('plugin_name', pluginName);
         formData.append('priority', newPriority);

         try {
           const response = await fetch(`{{ root_path }}/admin/tools/bulk/plugins/priority`, {
             method: 'POST',
             body: formData
           });
           if (response.ok) {
             // Reload plugin status to get fresh data from server
             await this.loadPluginStatus();
             window.dispatchEvent(new Event('plugin-priority-changed'));
             htmx.trigger('#tools-table', 'refresh');
           } else {
             const data = await response.json();
             console.error('Failed to update plugin priority:', data.message || 'Unknown error');
             alert('Failed to update priority: ' + (data.message || 'Unknown error'));
           }
         } catch (e) {
           console.error('Failed to update plugin priority:', e);
           alert('Failed to update priority: ' + e.message);
         }
       },
       getNextPriority() {
         // Calculate next priority: max(existing) + 10, or 10 if none
         if (!this.pluginStatus || !this.pluginStatus.plugin_status) return 10;

         let maxPriority = 0;
         // plugin_status is { pluginName: pluginData }, not { toolId: [plugins] }
         for (const plugin of Object.values(this.pluginStatus.plugin_status)) {
           if (plugin.priority) {
             const priority = Number(plugin.priority);
             if (priority > maxPriority) {
               maxPriority = priority;
             }
           }
         }

         console.log('Calculated next priority:', maxPriority > 0 ? maxPriority + 10 : 10, 'from max:', maxPriority);
         return maxPriority > 0 ? maxPriority + 10 : 10;
       }
     }"
     @plugin-modal-opened.window="loadPluginStatus()"
     @plugin-added.window="loadPluginStatus()"
     @plugin-removed.window="loadPluginStatus()">
  <div class="fixed inset-0 z-50 overflow-y-auto">
    <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
      <div class="relative transform overflow-hidden rounded-lg bg-white dark:bg-gray-800 text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-3xl"
           @click.stop>

        <!-- Header -->
        <div class="bg-indigo-600 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 class="text-lg font-semibold text-white flex items-center">
              <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a2 2 0 114 0v1a1 1 0 001 1h3a1 1 0 011 1v3a1 1 0 01-1 1h-1a2 2 0 100 4h1a1 1 0 011 1v3a1 1 0 01-1 1h-3a1 1 0 01-1-1v-1a2 2 0 10-4 0v1a1 1 0 01-1 1H7a1 1 0 01-1-1v-3a1 1 0 00-1-1H4a2 2 0 110-4h1a1 1 0 001-1V7a1 1 0 011-1h3a1 1 0 001-1V4z"/>
              </svg>
              Configure Plugins (<span x-text="$store.toolsPanel.selectedTools.length"></span> tools selected)
            </h3>
            <button @click="$store.toolsPanel.showBulkPluginModal = false"
                    class="text-white hover:text-gray-200 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
              </svg>
            </button>
          </div>
        </div>

        <!-- Body -->
        <div class="px-6 py-4">
          <!-- Selected Tools List -->
          <div class="mb-6">
            <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Selected Tools:</h4>
            <div class="bg-gray-50 dark:bg-gray-900 rounded-md p-3 max-h-32 overflow-y-auto">
              <div class="flex flex-wrap gap-2">
                <template x-for="toolId in $store.toolsPanel.selectedTools" :key="toolId">
                  <span class="inline-flex items-center px-2 py-1 rounded-md text-xs font-medium bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-200">
                    <span x-text="pluginStatus && pluginStatus.tool_names && pluginStatus.tool_names[toolId] ? pluginStatus.tool_names[toolId] : toolId"></span>
                  </span>
                </template>
              </div>
            </div>
          </div>

          <!-- Current Plugin Configuration -->
          <div class="mb-6" x-show="!loadingStatus && pluginStatus">
            <div class="flex items-center justify-between mb-2">
              <h4 class="text-sm font-medium text-gray-700 dark:text-gray-300">Currently Configured Plugins:</h4>
              <div class="flex items-center space-x-2">
                <button type="button"
                        x-show="selectedForRemoval.length > 0"
                        @click="removeSelectedPlugins()"
                        class="px-3 py-1 text-xs font-medium text-white bg-red-600 rounded-md hover:bg-red-700 transition-colors">
                  Remove Selected (<span x-text="selectedForRemoval.length"></span>)
                </button>
                <button type="button"
                        x-show="pluginStatus && pluginStatus.plugin_status && Object.keys(pluginStatus.plugin_status).length > 0"
                        @click="if(confirm('Remove ALL plugins from all selected tools? This cannot be undone.')) { clearAllPlugins() }"
                        class="px-3 py-1 text-xs font-medium text-red-600 border border-red-600 rounded-md hover:bg-red-50 dark:hover:bg-red-900/20 transition-colors">
                  Clear All
                </button>
              </div>
            </div>

            <template x-if="loadingStatus">
              <div class="text-center py-4">
                <svg class="inline w-5 h-5 text-gray-400 animate-spin" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                <span class="ml-2 text-sm text-gray-500">Loading...</span>
              </div>
            </template>

            <template x-if="!loadingStatus && pluginStatus && pluginStatus.plugin_status && Object.keys(pluginStatus.plugin_status).length > 0">
              <div class="bg-gray-50 dark:bg-gray-900 rounded-md p-3 max-h-64 overflow-y-auto space-y-4">
                <!-- Pre-invoke Hooks -->
                <div>
                  <h5 class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2 uppercase tracking-wider">Pre-Invoke Hooks</h5>
                  <div class="space-y-1">
                    <template x-for="[pluginName, status] in Object.entries(pluginStatus.plugin_status).filter(([name, s]) => s.pre_hooks && s.pre_hooks.length > 0).sort((a, b) => (a[1].priority || 0) - (b[1].priority || 0))" :key="`pre-${pluginName}`">
                      <div class="flex items-center text-xs hover:bg-gray-100 dark:hover:bg-gray-800 p-2 rounded">
                        <input type="checkbox"
                               :value="pluginName"
                               x-model="selectedForRemoval"
                               class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300" x-text="pluginName"></span>
                        <div class="flex items-center space-x-1 mr-2">
                          <label class="text-xs text-gray-500 dark:text-gray-400">p:</label>
                          <input type="number"
                                 :value="status.priority || 0"
                                 @blur="if($event.target.value != (status.priority || 0)) { updatePluginPriority(pluginName, $event.target.value) }"
                                 @keydown.enter="$event.target.blur()"
                                 min="0"
                                 max="1000"
                                 class="w-16 px-2 py-0.5 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <template x-if="status.status === 'all'">
                          <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                            <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            All
                          </span>
                        </template>
                        <template x-if="status.status === 'some'">
                          <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                            <span x-text="`${status.count}/${status.total}`"></span>
                          </span>
                        </template>
                      </div>
                    </template>
                  </div>
                </div>

                <!-- Post-invoke Hooks -->
                <div>
                  <h5 class="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-2 uppercase tracking-wider">Post-Invoke Hooks</h5>
                  <div class="space-y-1">
                    <template x-for="[pluginName, status] in Object.entries(pluginStatus.plugin_status).filter(([name, s]) => s.post_hooks && s.post_hooks.length > 0).sort((a, b) => (a[1].priority || 0) - (b[1].priority || 0))" :key="`post-${pluginName}`">
                      <div class="flex items-center text-xs hover:bg-gray-100 dark:hover:bg-gray-800 p-2 rounded">
                        <input type="checkbox"
                               :value="pluginName"
                               x-model="selectedForRemoval"
                               class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-2">
                        <span class="flex-1 font-medium text-gray-700 dark:text-gray-300" x-text="pluginName"></span>
                        <div class="flex items-center space-x-1 mr-2">
                          <label class="text-xs text-gray-500 dark:text-gray-400">p:</label>
                          <input type="number"
                                 :value="status.priority || 0"
                                 @blur="if($event.target.value != (status.priority || 0)) { updatePluginPriority(pluginName, $event.target.value) }"
                                 @keydown.enter="$event.target.blur()"
                                 min="0"
                                 max="1000"
                                 class="w-16 px-2 py-0.5 text-xs border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-1 focus:ring-indigo-500">
                        </div>
                        <template x-if="status.status === 'all'">
                          <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200">
                            <svg class="w-3 h-3 mr-0.5" fill="currentColor" viewBox="0 0 20 20">
                              <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                            </svg>
                            All
                          </span>
                        </template>
                        <template x-if="status.status === 'some'">
                          <span class="inline-flex items-center px-2 py-0.5 rounded-md bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200">
                            <span x-text="`${status.count}/${status.total}`"></span>
                          </span>
                        </template>
                      </div>
                    </template>
                  </div>
                </div>
              </div>
            </template>

            <template x-if="!loadingStatus && pluginStatus && (!pluginStatus.plugin_status || Object.keys(pluginStatus.plugin_status).length === 0)">
              <div class="bg-gray-50 dark:bg-gray-900 rounded-md p-3 text-center">
                <p class="text-sm text-gray-500 dark:text-gray-400">No plugins configured on selected tools</p>
              </div>
            </template>
          </div>

          <!-- Add Plugin Section -->
          <div class="border-b border-gray-200 dark:border-gray-700 mb-4 pb-2">
            <h4 class="text-sm font-semibold text-gray-700 dark:text-gray-300">âž• Add Plugin</h4>
          </div>

          <div>
            <form hx-post="{{ root_path }}/admin/tools/bulk/plugins"
                  hx-swap="none"
                  hx-on::after-request="if(event.detail.successful) {
                    const form = event.target;
                    window.dispatchEvent(new Event('plugin-added'));
                    htmx.trigger('#tools-table', 'refresh');
                    form.querySelector('[name=plugin_name]').value = '';
                    form.querySelector('[name=config]').value = '';
                    form.querySelector('[name=override]').checked = false;
                    form.querySelector('[name=mode]').value = '';
                    form.querySelector('[name=reverse_order_on_post]').checked = false;
                    const hooksSelect = form.querySelector('[name=hooks]');
                    if (hooksSelect) Array.from(hooksSelect.options).forEach(opt => opt.selected = false);
                  }"
                  class="space-y-4"
                  x-ref="addForm">

              <!-- Hidden field for selected tool IDs -->
              <template x-for="toolId in $store.toolsPanel.selectedTools" :key="toolId">
                <input type="hidden" name="tool_ids" :value="toolId">
              </template>

              <div>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                  Select Plugin
                </label>
                <select name="plugin_name" required
                        x-ref="pluginSelect"
                        class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                  <option value="">Choose a plugin...</option>
                  {% if plugin_manager %}
                  {% for plugin in plugin_manager.get_tool_plugins_with_hooks() %}
                  <option value="{{ plugin.name }}">{{ plugin.name }}{% if plugin.description %} - {{ plugin.description }}{% endif %}</option>
                  {% endfor %}
                  {% endif %}
                </select>
              </div>

              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Priority
                  </label>
                  <input type="number" name="priority" x-model="nextPriority" min="1" max="1000"
                         class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Hooks (optional)
                  </label>
                  <select name="hooks" multiple size="2"
                          class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                    <option value="tool_pre_invoke">Pre-invoke</option>
                    <option value="tool_post_invoke">Post-invoke</option>
                  </select>
                </div>
              </div>

              <!-- Advanced Configuration Section -->
              <div class="border-t border-gray-200 dark:border-gray-700 pt-4 mt-4">
                <h5 class="text-sm font-semibold text-gray-700 dark:text-gray-300 mb-3">Advanced Configuration</h5>

                <!-- Config JSON -->
                <div class="mb-4">
                  <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                    Config (JSON)
                    <span class="text-xs text-gray-500 font-normal">Optional plugin-specific configuration</span>
                  </label>
                  <textarea name="config" rows="3" placeholder='{"key": "value"}'
                            class="w-full px-3 py-2 text-sm font-mono border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500"></textarea>
                  <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Enter valid JSON for plugin configuration</p>
                </div>

                <!-- Grid for smaller fields -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                  <!-- Override -->
                  <div class="flex items-center space-x-2">
                    <input type="checkbox" name="override" id="bulk_override" value="true"
                           class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-700">
                    <label for="bulk_override" class="text-sm text-gray-700 dark:text-gray-300">
                      Override
                      <span class="text-xs text-gray-500 block">Replace existing config</span>
                    </label>
                  </div>

                  <!-- Mode -->
                  <div>
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                      Mode
                    </label>
                    <select name="mode"
                            class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-100 focus:ring-2 focus:ring-indigo-500">
                      <option value="">Default</option>
                      <option value="enforce">Enforce (block on error)</option>
                      <option value="enforce_ignore_error">Enforce (continue on error)</option>
                      <option value="permissive">Permissive (audit only)</option>
                      <option value="disabled">Disabled</option>
                    </select>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Controls how the plugin enforces its rules</p>
                  </div>
                </div>
              </div>

              <!-- Reverse post-hooks checkbox -->
              <div class="flex items-center space-x-2 py-2">
                <input type="checkbox" name="reverse_order_on_post" id="bulk_reverse_post" value="true"
                       class="rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 dark:border-gray-600 dark:bg-gray-700">
                <label for="bulk_reverse_post" class="text-sm text-gray-700 dark:text-gray-300">
                  Reverse post-hooks order
                  <span class="text-xs text-gray-500 block">Post-hooks will run in reverse order (LIFO - last added runs first)</span>
                </label>
              </div>

              <p class="text-xs text-gray-500 dark:text-gray-400">
                This plugin will be added to all <span x-text="$store.toolsPanel.selectedTools.length"></span> selected tools.
              </p>

              <div class="flex justify-end space-x-3 pt-4 border-t border-gray-200 dark:border-gray-700">
                <button type="button"
                        @click="$store.toolsPanel.showBulkPluginModal = false"
                        class="px-4 py-2 text-sm font-medium text-gray-700 bg-white border border-gray-300 rounded-md hover:bg-gray-50 dark:bg-gray-700 dark:text-gray-300 dark:border-gray-600 dark:hover:bg-gray-600 transition-colors">
                  Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 transition-colors">
                  Add to Selected Tools
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
