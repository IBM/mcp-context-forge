# üöÄ MCP Context Forge Gateway ‚Äî GitLab CI/CD Pipeline
#
# Runner: Ubuntu 24.04 shell executor (no Python pre-installed).
# Strategy:
#   1. Try  sudo apt-get install python3  (works if sudo is allowed)
#   2. Fall back to downloading a portable python-build-standalone release
#      from GitHub (indygreg/python-build-standalone)

stages:
  - setup
  - quality
  - test

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  DATABASE_URL: "sqlite:///:memory:"
  TEST_DATABASE_URL: "sqlite:///:memory:"
  ARGON2ID_TIME_COST: "1"
  ARGON2ID_MEMORY_COST: "1024"
  FF_USE_FASTZIP: "true"
  # Portable Python install location (inside project dir so it can be cached)
  PYTHON_STANDALONE_DIR: "$CI_PROJECT_DIR/.python-standalone"

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# ---------------------------------------------------------------------------
# Helper: ensure python3 is on PATH
# ---------------------------------------------------------------------------
.ensure_python: &ensure_python
  - |
    # ‚îÄ‚îÄ Ensure python3 is available ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if command -v python3 &>/dev/null; then
      echo "‚úÖ python3 already available: $(python3 --version)"
    elif command -v sudo &>/dev/null; then
      echo "üì¶ Installing Python 3 via sudo apt-get ‚Ä¶"
      sudo apt-get update -qq
      sudo apt-get install -y -qq python3 python3-venv python3-pip python3-dev gcc g++ libffi-dev 2>/dev/null
      echo "‚úÖ python3 installed: $(python3 --version)"
    else
      echo "üì¶ sudo not available ‚Äì downloading standalone Python ‚Ä¶"
      if [ ! -x "$PYTHON_STANDALONE_DIR/python/bin/python3" ]; then
        TARBALL="cpython-3.12.8+20250106-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz"
        URL="https://github.com/indygreg/python-build-standalone/releases/download/20250106/${TARBALL}"
        mkdir -p "$PYTHON_STANDALONE_DIR"
        echo "   ‚¨á  Downloading from $URL"
        wget -q -O "/tmp/python.tar.gz" "$URL"
        tar -xzf /tmp/python.tar.gz -C "$PYTHON_STANDALONE_DIR"
        rm -f /tmp/python.tar.gz
      fi
      export PATH="$PYTHON_STANDALONE_DIR/python/bin:$PATH"
      echo "‚úÖ standalone python3: $(python3 --version)"
    fi
    # Make sure python3 is on PATH for the rest of the job
    if [ -d "$PYTHON_STANDALONE_DIR/python/bin" ]; then
      export PATH="$PYTHON_STANDALONE_DIR/python/bin:$PATH"
    fi

# ---------------------------------------------------------------------------
# 1Ô∏è‚É£  SETUP ‚Äî Install Python & create cached venv
# ---------------------------------------------------------------------------
setup:
  stage: setup
  script:
    - *ensure_python
    - python3 --version
    # Create venv and install deps
    - python3 -m venv .venv
    - source .venv/bin/activate
    - python3 -m ensurepip --upgrade 2>/dev/null || true
    - python3 -m pip install --quiet --upgrade pip
    - python3 -m pip install --quiet -e .
    - python3 -m pip install --quiet black isort pytest pytest-cov pytest-xdist
    - echo "‚úÖ Setup complete ‚Äî $(python3 --version), pip $(pip --version 2>/dev/null | awk '{print $2}')"
  cache:
    key: "py-${CI_COMMIT_REF_SLUG}"
    paths:
      - .venv/
      - .python-standalone/
    policy: push

# Shared template for jobs that need the cached venv
.python_job:
  before_script:
    - *ensure_python
    - source .venv/bin/activate
  cache:
    key: "py-${CI_COMMIT_REF_SLUG}"
    paths:
      - .venv/
      - .python-standalone/
    policy: pull
  needs:
    - job: setup
      artifacts: false

# ---------------------------------------------------------------------------
# 2Ô∏è‚É£  QUALITY ‚Äî Formatting checks (run in parallel)
# ---------------------------------------------------------------------------
black:
  extends: .python_job
  stage: quality
  allow_failure: true          # ‚ö†Ô∏è  remove once team runs:  black -l 200 mcpgateway
  script:
    - black --check -l 200 mcpgateway

isort:
  extends: .python_job
  stage: quality
  allow_failure: true          # ‚ö†Ô∏è  remove once team runs:  isort mcpgateway
  script:
    - isort --check-only --diff mcpgateway

# ---------------------------------------------------------------------------
# 3Ô∏è‚É£  TEST ‚Äî Pytest with coverage
# ---------------------------------------------------------------------------
test:
  extends: .python_job
  stage: test
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  script:
    - pytest
        --ignore=tests/fuzz
        --cov=mcpgateway
        --cov-report=xml:coverage.xml
        --cov-report=html:htmlcov
        --cov-report=term
        --cov-branch
        --cov-fail-under=60
        --junitxml=junit.xml
        --tb=short
        -n 4
        -q
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
      - junit.xml
      - htmlcov/
    expire_in: 7 days