# üöÄ MCP Context Forge Gateway ‚Äî Simplified GitLab CI/CD Pipeline
# Runs on merge requests + main branch + tags
# Stages:
#   1) quality ‚Äî black, isort (fast, high value)
#   2) test    ‚Äî pytest + coverage
#
# NOTE: Shell executor with no outbound internet.
#       Uses pip to bootstrap uv from bundled cache or PyPI (if available),
#       then uv handles the rest. Falls back to pip-only if uv unavailable.

stages:
  - quality
  - test

default:
  before_script:
    - export PATH="$HOME/.local/bin:$PATH"
    # Try to use uv if already on the runner, otherwise fall back to pip
    - |
      if command -v uv &>/dev/null; then
        echo "‚úÖ uv found"
      elif command -v pip3 &>/dev/null; then
        pip3 install --user uv 2>/dev/null || true
      elif command -v pip &>/dev/null; then
        pip install --user uv 2>/dev/null || true
      fi
    # Create venv ‚Äî prefer uv, fall back to stdlib venv
    - |
      if command -v uv &>/dev/null; then
        uv venv .venv 2>/dev/null || python3 -m venv .venv
      else
        python3 -m venv .venv
      fi
    - source .venv/bin/activate
    # Install project + dev deps ‚Äî prefer uv (handles dependency-groups), fall back to pip
    - |
      if command -v uv &>/dev/null; then
        uv pip install --group dev . 2>/dev/null || pip install -e .
      else
        pip install -e .
        pip install black isort pytest pytest-cov pytest-xdist
      fi
  cache:
    key: "venv-${CI_COMMIT_REF_SLUG}"
    paths:
      - .venv/
    policy: pull-push

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  DATABASE_URL: "sqlite:///:memory:"
  TEST_DATABASE_URL: "sqlite:///:memory:"
  ARGON2ID_TIME_COST: "1"
  ARGON2ID_MEMORY_COST: "1024"
  FF_USE_FASTZIP: "true"

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# 1Ô∏è‚É£  QUALITY ‚Äî Formatting checks
black:
  stage: quality
  script:
    - black --check -l 200 mcpgateway

isort:
  stage: quality
  script:
    - isort --check-only --diff mcpgateway

# 2Ô∏è‚É£  TEST ‚Äî Pytest with coverage
test:
  stage: test
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  script:
    - pytest
        --ignore=tests/fuzz
        --cov=mcpgateway
        --cov-report=xml:coverage.xml
        --cov-report=html:htmlcov
        --cov-report=term
        --cov-branch
        --cov-fail-under=60
        --junitxml=junit.xml
        -n auto
        -v
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - coverage.xml
      - junit.xml
      - htmlcov/
    expire_in: 7 days
