# GitLab CI/CD Pipeline for MCP Gateway
# Python 3.11+ FastAPI application with comprehensive testing and deployment

variables:
  PYTHON_VERSION: "3.13"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

# Cache configuration for faster builds
cache:
  key: "${CI_COMMIT_REF_SLUG}-${PYTHON_VERSION}"
  paths:
    - .cache/pip
    - .venv/

# Pipeline stages
stages:
  - setup
  - lint
  - test
  - security
  - build
  - deploy

# Templates
.python_base:
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - apt-get update -qq && apt-get install -y -qq make git curl
    - pip install --upgrade pip uv
    - make venv
    - source .venv/bin/activate

.docker_base:
  image: docker:24-cli
  services:
    - docker:24-dind

# ============================================================
# SETUP STAGE
# ============================================================
setup:environment:
  extends: .python_base
  stage: setup
  script:
    - make install-dev
    - make check-env
  artifacts:
    paths:
      - .venv/
    expire_in: 1 hour
  only:
    - branches
    - tags
    - merge_requests

# ============================================================
# LINT STAGE
# ============================================================
lint:black:
  extends: .python_base
  stage: lint
  needs: ["setup:environment"]
  script:
    - make black
  allow_failure: false

lint:isort:
  extends: .python_base
  stage: lint
  needs: ["setup:environment"]
  script:
    - make isort
  allow_failure: false

lint:ruff:
  extends: .python_base
  stage: lint
  needs: ["setup:environment"]
  script:
    - make flake8  # ruff is used via flake8
  allow_failure: false

lint:pylint:
  extends: .python_base
  stage: lint
  needs: ["setup:environment"]
  script:
    - make pylint
  allow_failure: true  # Pylint can be strict

lint:mypy:
  extends: .python_base
  stage: lint
  needs: ["setup:environment"]
  script:
    - source .venv/bin/activate
    - mypy mcpgateway --config-file pyproject.toml
  allow_failure: true

# ============================================================
# TEST STAGE
# ============================================================
test:unit:
  extends: .python_base
  stage: test
  needs: ["setup:environment"]
  services:
    - postgres:15
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_mcp
    POSTGRES_USER: testuser
    POSTGRES_PASSWORD: testpass
    DATABASE_URL: "postgresql+psycopg://testuser:testpass@postgres:5432/test_mcp"
    REDIS_URL: "redis://redis:6379/0"
    TESTING: "true"
  script:
    - cp .env.example .env
    - echo "DATABASE_URL=${DATABASE_URL}" >> .env
    - echo "REDIS_URL=${REDIS_URL}" >> .env
    - make test
  coverage: '/(?i)total.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/'
  artifacts:
    reports:
      junit: test-results.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    paths:
      - htmlcov/
      - test-results.xml
      - coverage.xml
    expire_in: 30 days
    when: always

test:semantic-search:
  extends: .python_base
  stage: test
  needs: ["setup:environment"]
  variables:
    TESTING: "true"
    EMBEDDING_API_KEY: "test-key"
  script:
    - cp .env.example .env
    - echo "EMBEDDING_API_KEY=${EMBEDDING_API_KEY}" >> .env
    - make test-semantic-search
  allow_failure: false

test:integration:
  extends: .python_base
  stage: test
  needs: ["setup:environment"]
  services:
    - postgres:15
    - redis:7-alpine
  variables:
    POSTGRES_DB: test_mcp
    POSTGRES_USER: testuser
    POSTGRES_PASSWORD: testpass
    DATABASE_URL: "postgresql+psycopg://testuser:testpass@postgres:5432/test_mcp"
    REDIS_URL: "redis://redis:6379/0"
  script:
    - cp .env.example .env
    - echo "DATABASE_URL=${DATABASE_URL}" >> .env
    - echo "REDIS_URL=${REDIS_URL}" >> .env
    - source .venv/bin/activate
    - pytest tests/integration/ -v --tb=short
  allow_failure: true
  only:
    - main
    - develop
    - merge_requests

# ============================================================
# SECURITY STAGE
# ============================================================
security:bandit:
  extends: .python_base
  stage: security
  needs: ["setup:environment"]
  script:
    - make bandit
  allow_failure: false
  artifacts:
    reports:
      sast: bandit-report.json
    when: always

security:safety:
  extends: .python_base
  stage: security
  needs: ["setup:environment"]
  script:
    - source .venv/bin/activate
    - pip install safety
    - safety check --json || true
  allow_failure: true

security:semgrep:
  image: returntocorp/semgrep
  stage: security
  script:
    - semgrep --config=auto --json --output=semgrep.json . || true
  artifacts:
    reports:
      sast: semgrep.json
    when: always
  allow_failure: true

# ============================================================
# BUILD STAGE
# ============================================================
build:docker:
  extends: .docker_base
  stage: build
  needs:
    - job: test:unit
      artifacts: false
    - job: test:semantic-search
      artifacts: false
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -f Containerfile .
    - docker tag $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA $CI_REGISTRY_IMAGE:latest
    - docker push $CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA
    - docker push $CI_REGISTRY_IMAGE:latest
  only:
    - main
    - develop
    - tags

build:docker-lite:
  extends: .docker_base
  stage: build
  needs:
    - job: test:unit
      artifacts: false
  before_script:
    - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
  script:
    - docker build -t $CI_REGISTRY_IMAGE:lite-$CI_COMMIT_SHORT_SHA -f Containerfile.lite .
    - docker push $CI_REGISTRY_IMAGE:lite-$CI_COMMIT_SHORT_SHA
  only:
    - main
    - tags

# ============================================================
# DEPLOY STAGE
# ============================================================
deploy:staging:
  extends: .docker_base
  stage: deploy
  needs: ["build:docker"]
  environment:
    name: staging
    url: https://staging.mcpgateway.example.com
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $STAGING_HOST >> ~/.ssh/known_hosts
  script:
    - ssh $STAGING_USER@$STAGING_HOST "cd /opt/mcpgateway && docker-compose pull && docker-compose up -d"
  only:
    - develop
  when: manual

deploy:production:
  extends: .docker_base
  stage: deploy
  needs: ["build:docker"]
  environment:
    name: production
    url: https://mcpgateway.example.com
  before_script:
    - apk add --no-cache openssh-client
    - eval $(ssh-agent -s)
    - echo "$SSH_PRIVATE_KEY" | tr -d '\r' | ssh-add -
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    - ssh-keyscan $PRODUCTION_HOST >> ~/.ssh/known_hosts
  script:
    - ssh $PRODUCTION_USER@$PRODUCTION_HOST "cd /opt/mcpgateway && docker-compose pull && docker-compose up -d --no-deps app"
  only:
    - main
    - tags
  when: manual

deploy:kubernetes:
  image: bitnami/kubectl:latest
  stage: deploy
  needs: ["build:docker"]
  environment:
    name: production-k8s
    url: https://mcpgateway.example.com
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_CONTENT" | base64 -d > ~/.kube/config
  script:
    - kubectl set image deployment/mcpgateway mcpgateway=$CI_REGISTRY_IMAGE:$CI_COMMIT_SHORT_SHA -n production
    - kubectl rollout status deployment/mcpgateway -n production
  only:
    - tags
  when: manual

# ============================================================
# RELEASE AUTOMATION
# ============================================================
release:changelog:
  image: node:18-alpine
  stage: deploy
  needs: ["build:docker"]
  before_script:
    - apk add --no-cache git
    - npm install -g conventional-changelog-cli
  script:
    - conventional-changelog -p angular -i CHANGELOG.md -s
    - git config user.email ci@gitlab.com
    - git config user.name GitLabCI
    - git add CHANGELOG.md
    - git commit -m "chore update CHANGELOG [skip ci]" || true
    - git push https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git HEAD:${CI_COMMIT_BRANCH} || true
  only:
    - main
  when: manual

# ============================================================
# ADDITIONAL CHECKS
# ============================================================
verify:all:
  extends: .python_base
  stage: test
  needs: ["setup:environment"]
  script:
    - make verify
  allow_failure: true
  only:
    - merge_requests

docs:build:
  extends: .python_base
  stage: build
  needs: ["setup:environment"]
  script:
    - cd docs
    - pip install -r requirements.txt
    - make html
  artifacts:
    paths:
      - docs/_build/html/
    expire_in: 7 days
  only:
    - main
    - merge_requests
