stages:
  - test

test:
  stage: test
  before_script:
    - |
      if ! command -v python3 &>/dev/null; then
        wget -q -O /tmp/python.tar.gz "https://github.com/indygreg/python-build-standalone/releases/download/20250106/cpython-3.12.8+20250106-x86_64-unknown-linux-gnu-install_only_stripped.tar.gz"
        mkdir -p "$CI_PROJECT_DIR/.python"
        tar -xzf /tmp/python.tar.gz -C "$CI_PROJECT_DIR/.python"
        rm /tmp/python.tar.gz
      fi
    - export PATH="$CI_PROJECT_DIR/.python/python/bin:$PATH"
    - python3 -m venv .venv
    - source .venv/bin/activate
    - python3 -m pip install --upgrade pip
    - python3 -m pip install -e . 2>&1 | tail -20
    - python3 -m pip install pytest
    - echo "=== Verify key packages ==="
    - python3 -c "import url_normalize; print('url_normalize OK')"
    - python3 -c "import sqlalchemy; print('sqlalchemy OK')"
    - python3 -c "import fastapi; print('fastapi OK')"
  script:
    - export PATH="$CI_PROJECT_DIR/.python/python/bin:$PATH"
    - source .venv/bin/activate
    - pytest --ignore=tests/fuzz --tb=short -q
  variables:
    DATABASE_URL: "sqlite:///:memory:"