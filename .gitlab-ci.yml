# ðŸš€ MCP Context Forge Gateway â€” Simplified GitLab CI/CD Pipeline
# Runs on merge requests + main branch + tags
# Stages:
#   1) quality â€” black, isort (fast, high value)
#   2) test    â€” pytest + coverage
#
# NOTE: Shell executor â€” runner has python3 but no pip/uv in PATH.
#       We bootstrap pip via ensurepip, then install everything with python3 -m pip.

stages:
  - debug

debug-runner:
  stage: debug
  script:
    - echo "=== OS ==="
    - cat /etc/os-release 2>/dev/null || echo "no os-release"
    - uname -a
    - echo "=== PATH ==="
    - echo "$PATH"
    - echo "=== Python variants ==="
    - which python python3 python3.11 python3.12 2>/dev/null || echo "none found in which"
    - ls /usr/bin/python* /usr/local/bin/python* 2>/dev/null || echo "none in /usr/bin or /usr/local/bin"
    - find / -maxdepth 4 -name 'python*' -type f 2>/dev/null | head -20 || true
    - echo "=== pip variants ==="
    - which pip pip3 2>/dev/null || echo "none found"
    - echo "=== Package managers ==="
    - which apt apt-get yum dnf apk brew conda 2>/dev/null || echo "none found"
    - echo "=== Other tools ==="
    - which node npm docker curl wget git make gcc 2>/dev/null || echo "none found"
    - echo "=== User & perms ==="
    - whoami
    - id

variables:
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PYTHONUNBUFFERED: "1"
  DATABASE_URL: "sqlite:///:memory:"
  TEST_DATABASE_URL: "sqlite:///:memory:"
  ARGON2ID_TIME_COST: "1"
  ARGON2ID_MEMORY_COST: "1024"
  FF_USE_FASTZIP: "true"

workflow:
  rules:
    - if: $CI_MERGE_REQUEST_IID
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_TAG

# Remaining jobs temporarily disabled â€” uncomment after debug
# black:
#   stage: quality
#   script:
#     - black --check -l 200 mcpgateway
# isort:
#   stage: quality
#   script:
#     - isort --check-only --diff mcpgateway
# test:
#   stage: test
#   script:
#     - pytest
