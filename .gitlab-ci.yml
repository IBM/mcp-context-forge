stages:
  - test

test:
  stage: test
  before_script:
    - sudo apt-get update -qq && sudo apt-get install -y -qq python3 python3-venv python3-dev gcc g++ libffi-dev
    - python3 -m venv .venv
    - source .venv/bin/activate
    - python3 -m ensurepip --upgrade 2>/dev/null || true
    - python3 -m pip install --quiet --upgrade pip
    - python3 -m pip install --quiet -e ".[test]" 2>/dev/null || python3 -m pip install --quiet -e .
    - python3 -m pip install --quiet pytest pytest-cov pytest-xdist
  script:
    - source .venv/bin/activate
    - pytest --ignore=tests/fuzz --tb=short -q
  variables:
    DATABASE_URL: "sqlite:///:memory:"